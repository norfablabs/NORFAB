
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Network Automations Fabric documentation">
      
      
        <meta name="author" content="Denis Mulyalin">
      
      
        <link rel="canonical" href="https://docs.norfablabs.com/workers/netbox/api_reference_workers_netbox_worker/">
      
      
        <link rel="prev" href="../../nornir/api_reference_workers_nornir_worker/">
      
      
        <link rel="next" href="../../fastapi/api_reference_workers_fastapi_worker/">
      
      
        
      
      
      <link rel="icon" href="../../../images/logo.jpg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Netbox Worker - Network Automations Fabric [NORFAB]</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#norfab.workers.netbox_worker.NetboxAllocationError" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Network Automations Fabric [NORFAB]" class="md-header__button md-logo" aria-label="Network Automations Fabric [NORFAB]" data-md-component="logo">
      
  <img src="../../../images/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Network Automations Fabric [NORFAB]
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Netbox Worker
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="deep-orange"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/norfablabs/NORFAB" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    norfablabs/norfab
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../norfab_docker_deployment/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../services_overview/" class="md-tabs__link">
          
  
  
  Services

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../clients_overview/" class="md-tabs__link">
          
  
  
  Clients

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../customization/norfab_hooks/" class="md-tabs__link">
          
  
  
  Customization

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../tags/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development/documentation_style_guide/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../norfab_help_with_norfab/" class="md-tabs__link">
        
  
  
    
  
  Contact Us

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Network Automations Fabric [NORFAB]" class="md-nav__button md-logo" aria-label="Network Automations Fabric [NORFAB]" data-md-component="logo">
      
  <img src="../../../images/logo.jpg" alt="logo">

    </a>
    Network Automations Fabric [NORFAB]
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/norfablabs/NORFAB" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    norfablabs/norfab
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_1" >
        
          
          <label class="md-nav__link" for="__nav_1_1" id="__nav_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Overview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_why_use_norfab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why use NORFAB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4_1" >
        
          
          <label class="md-nav__link" for="__nav_1_4_1" id="__nav_1_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference_architecture_norfab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NORFAB Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference_architecture_nfp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NORFAB Protocol RFC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference_norfab_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_docker_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_distributed_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Services Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Containerlab
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Containerlab
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_3" >
        
          
          <label class="md-nav__link" for="__nav_3_2_3" id="__nav_3_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_deploy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_deploy_netbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy Netbox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_destroy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Destroy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_save/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Save
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_restart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Restart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_inspect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inspect
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/services_containerlab_service_tasks_nornir_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Nornir Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nornir
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nornir
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3_3" id="__nav_3_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_task/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Task
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_cfg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CFG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_parse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_diagram/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diagram
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_file_copy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Copy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_tasks_runtime_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Runtime Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/services_nornir_service_jinja2_filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jinja2 Filters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Netbox
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Netbox
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_graphql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GraphQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_rest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    REST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Devices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Connections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_circuits/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Circuits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_bgp_peerings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get BGP Peerings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_nornir_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Nornir Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_get_containerlab_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Containerlab Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_create_ip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create IP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_create_prefix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Prefix
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_create_device_interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Device Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_sync_device_facts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sync Device Facts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_sync_device_interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sync Device Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../services_netbox_service_tasks_sync_device_ip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sync Device IP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Agent
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Agent
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agent/services_agent_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agent/services_agent_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3" >
        
          
          <label class="md-nav__link" for="__nav_3_5_3" id="__nav_3_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agent/services_agent_service_tasks_chat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    FastAPI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    FastAPI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastapi/services_fastapi_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastapi/services_fastapi_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_3" >
        
          
          <label class="md-nav__link" for="__nav_3_6_3" id="__nav_3_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastapi/services_fastapi_service_task_auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Auth
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    FastMCP
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    FastMCP
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastmcp/services_fastmcp_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastmcp/services_fastmcp_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7_3" >
        
          
          <label class="md-nav__link" for="__nav_3_7_3" id="__nav_3_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastmcp/services_fastmcp_service_task_get_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workflow
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/services_workflow_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/services_workflow_service_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_3" >
        
          
          <label class="md-nav__link" for="__nav_3_8_3" id="__nav_3_8_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/services_workflow_service_tasks_run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Run
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    NORFAB Built-ins
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    NORFAB Built-ins
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_norfab_mmi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MMI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_norfab_inventory_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inventory Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_norfab_file_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_norfab_jobs_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jobs Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../services_norfab_events_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Events Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Clients
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Clients
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clients_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clients Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clients_nfcli_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NFCLI Shell Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clients_python_api_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python API Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../clients_robot_client_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ROBOT Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Customization
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Customization
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../customization/norfab_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NORFAB Hooks System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Service Plugins
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Service Plugins
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../customization/service_plugin_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../customization/service_plugin_local/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Plugin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../customization/service_plugin_module/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python Module Plugin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tags
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" checked>
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_1" >
        
          
          <label class="md-nav__link" for="__nav_6_2_1" id="__nav_6_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_nfapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NFAPI (Python API)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_broker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Broker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Worker Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_simple_inventory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simple Inventory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_core_norfab_exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_6_2_2" id="__nav_6_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Built-in Workers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Built-in Workers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlab/api_reference_workers_containerlab_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Containerlab Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nornir/api_reference_workers_nornir_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nornir Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Netbox Worker
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Netbox Worker
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxAllocationError" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetboxAllocationError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.UnsupportedNetboxVersion" class="md-nav__link">
    <span class="md-ellipsis">
      
        UnsupportedNetboxVersion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetboxWorker
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NetboxWorker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.worker_exit" class="md-nav__link">
    <span class="md-ellipsis">
      
        worker_exit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_netbox_status" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_netbox_status
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_compatibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.has_plugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_plugin
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_list" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_list
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_clear
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_get" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_get
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.graphql" class="md-nav__link">
    <span class="md-ellipsis">
      
        graphql
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.rest" class="md-nav__link">
    <span class="md-ellipsis">
      
        rest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_devices" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_devices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_circuits" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_circuits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_nornir_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_hosts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_nornir_hosts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_facts" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_facts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.update_interfaces_description" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_interfaces_description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_ip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_ip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_prefix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_containerlab_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_containerlab_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.delete_branch" class="md-nav__link">
    <span class="md-ellipsis">
      
        delete_branch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.expand_alphanumeric_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        expand_alphanumeric_range
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_device_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_device_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_bgp_peerings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_bgp_peerings
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.compare_netbox_object_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        compare_netbox_object_state
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastapi/api_reference_workers_fastapi_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FastAPI Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastmcp/api_reference_workers_fastmcp_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FastMCP Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agent/api_reference_workers_agent_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../workflow/api_reference_workers_workflow_worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow Worker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_3" >
        
          
          <label class="md-nav__link" for="__nav_6_2_3" id="__nav_6_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Built-in Clients
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Built-in Clients
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_clients_nfcli_client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NFCLI Client API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api_reference_clients_robot_client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ROBOT Client API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/documentation_style_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation Style Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/norfab_testing_framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NORFAB Testing Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/netbox_service_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Netbox Service Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../norfab_help_with_norfab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contact Us
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxAllocationError" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetboxAllocationError
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.UnsupportedNetboxVersion" class="md-nav__link">
    <span class="md-ellipsis">
      
        UnsupportedNetboxVersion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker" class="md-nav__link">
    <span class="md-ellipsis">
      
        NetboxWorker
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NetboxWorker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.worker_exit" class="md-nav__link">
    <span class="md-ellipsis">
      
        worker_exit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_netbox_status" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_netbox_status
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_compatibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.has_plugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        has_plugin
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_list" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_list
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_clear
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.cache_get" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_get
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.graphql" class="md-nav__link">
    <span class="md-ellipsis">
      
        graphql
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.rest" class="md-nav__link">
    <span class="md-ellipsis">
      
        rest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_devices" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_devices
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_circuits" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_circuits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_nornir_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_hosts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_nornir_hosts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_facts" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_facts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.update_interfaces_description" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_interfaces_description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        sync_device_ip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_ip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_prefix" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_prefix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_containerlab_inventory" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_containerlab_inventory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.delete_branch" class="md-nav__link">
    <span class="md-ellipsis">
      
        delete_branch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.expand_alphanumeric_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        expand_alphanumeric_range
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.create_device_interfaces" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_device_interfaces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.NetboxWorker.get_bgp_peerings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_bgp_peerings
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#norfab.workers.netbox_worker.compare_netbox_object_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        compare_netbox_object_state
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Netbox Worker</h1>

<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="norfab.workers.netbox_worker.NetboxAllocationError" class="doc doc-heading">
            <code>NetboxAllocationError</code>


<a href="#norfab.workers.netbox_worker.NetboxAllocationError" class="headerlink" title="Permanent link"></a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised when there is an error in allocating resource in Netbox</p>









    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="norfab.workers.netbox_worker.UnsupportedNetboxVersion" class="doc doc-heading">
            <code>UnsupportedNetboxVersion</code>


<a href="#norfab.workers.netbox_worker.UnsupportedNetboxVersion" class="headerlink" title="Permanent link"></a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised when there is an error in allocating resource in Netbox</p>









    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="norfab.workers.netbox_worker.NetboxWorker" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">NetboxWorker</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">worker_name</span><span class="p">,</span> <span class="n">exit_event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_done_event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_queue</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker" class="headerlink" title="Permanent link"></a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="NFPWorker(inventory: NorFabInventory, broker: str, service: str, name: str, exit_event: object, log_level: str = None, log_queue: object = None, multiplier: int = 6, keepalive: int = 2500) (norfab.core.worker.NFPWorker)" href="../../../api_reference_core_norfab_worker/#norfab.core.worker.NFPWorker">NFPWorker</a></code></p>



        <p>NetboxWorker class for interacting with Netbox API and managing inventory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inventory</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The inventory data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>broker</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The broker instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>worker_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the worker.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exit_event</code>
            </td>
            <td>
                  <code><span title="threading.Event">Event</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Event to signal exit.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_done_event</code>
            </td>
            <td>
                  <code><span title="threading.Event">Event</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Event to signal initialization completion.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_level</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logging level.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_queue</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Queue for logging.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the inventory has no Netbox instances.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="norfab.workers.netbox_worker.NetboxWorker.default_instance">default_instance</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default Netbox instance name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="norfab.workers.netbox_worker.NetboxWorker.inventory">inventory</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inventory data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="norfab.workers.netbox_worker.NetboxWorker.nb_version">nb_version</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox version.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="norfab.workers.netbox_worker.NetboxWorker.compatible_ge_v4">compatible_ge_v4</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum supported Netbox v4 version (4.4.0+).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">inventory</span><span class="p">,</span>
    <span class="n">broker</span><span class="p">,</span>
    <span class="n">worker_name</span><span class="p">,</span>
    <span class="n">exit_event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">init_done_event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log_queue</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">inventory</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">SERVICE</span><span class="p">,</span> <span class="n">worker_name</span><span class="p">,</span> <span class="n">exit_event</span><span class="p">,</span> <span class="n">log_level</span><span class="p">,</span> <span class="n">log_queue</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_done_event</span> <span class="o">=</span> <span class="n">init_done_event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># get inventory from broker</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_inventory</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Broker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="si">}</span><span class="s2"> returned no inventory for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, killing myself...&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;instances&quot;</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - inventory has no Netbox instances&quot;</span>

    <span class="c1"># extract parameters from imvemtory</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">netbox_connect_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;netbox_connect_timeout&quot;</span><span class="p">,</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">netbox_read_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;netbox_read_timeout&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_use&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl&quot;</span><span class="p">,</span> <span class="mi">31557600</span><span class="p">)</span>  <span class="c1"># 1 Year</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">branch_create_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;branch_create_timeout&quot;</span><span class="p">,</span> <span class="mi">120</span>
    <span class="p">)</span>

    <span class="c1"># find default instance</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span> <span class="o">=</span> <span class="n">name</span>

    <span class="c1"># check Netbox compatibility</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_verify_compatibility</span><span class="p">()</span>

    <span class="c1"># instantiate cache</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_diskcache</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">init_done_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Started&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.worker_exit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">worker_exit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.worker_exit" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Worker exist sanity checks. Closes the cache if it exists.</p>
<p>This method checks if the cache attribute is present and not None.
If the cache exists, it closes the cache to release any resources
associated with it.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">worker_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Worker exist sanity checks. Closes the cache if it exists.</span>

<span class="sd">    This method checks if the cache attribute is present and not None.</span>
<span class="sd">    If the cache exists, it closes the cache to release any resources</span>
<span class="sd">    associated with it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_inventory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_inventory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_inventory" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>NorFab Task to return running inventory for NetBox worker.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the NetBox inventory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NorFab Task to return running inventory for NetBox worker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the NetBox inventory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_inventory&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_version</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_version" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieves the version information of Netbox instances.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the version information of the Netbox</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the version information of Netbox instances.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the version information of the Netbox</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">libs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;norfab&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pynetbox&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requests&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
        <span class="s2">&quot;diskcache&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;netbox_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># get version of packages installed</span>
    <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">libs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libs</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_version&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">libs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_netbox_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_netbox_status</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_netbox_status" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve the status of NetBox instances.</p>
<p>This method queries the status of a specific NetBox instance if the
<code>instance</code> parameter is provided. If no instance is specified, it
queries the status of all instances in the NetBox inventory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the specific NetBox instance to query.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the status of the requested NetBox
  instance(s).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_netbox_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the status of NetBox instances.</span>

<span class="sd">    This method queries the status of a specific NetBox instance if the</span>
<span class="sd">    `instance` parameter is provided. If no instance is specified, it</span>
<span class="sd">    queries the status of all instances in the NetBox inventory.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance (str, optional): The name of the specific NetBox instance to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the status of the requested NetBox</span>
<span class="sd">              instance(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="p">{},</span> <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_netbox_status&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_netbox_status</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_inventory</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_netbox_status</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_compatibility" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_compatibility</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_compatibility" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Checks the compatibility of Netbox instances based on their version.</p>
<p>This method retrieves the status and version of Netbox instances and determines
if they are compatible with the required versions. It logs a warning if any
instance is not reachable.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where the keys are the instance names and the values are
  booleans indicating compatibility (True/False) or None if the instance
  is not reachable.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the compatibility of Netbox instances based on their version.</span>

<span class="sd">    This method retrieves the status and version of Netbox instances and determines</span>
<span class="sd">    if they are compatible with the required versions. It logs a warning if any</span>
<span class="sd">    instance is not reachable.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the instance names and the values are</span>
<span class="sd">              booleans indicating compatibility (True/False) or None if the instance</span>
<span class="sd">              is not reachable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_compatibility&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">netbox_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_netbox_status</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">netbox_status</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> Netbox instance not reachable&quot;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;-docker-&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;netbox-version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;netbox-version&quot;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-docker-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;netbox-version&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="c1"># check Netbox 4.4+ compatibility</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.has_plugin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_plugin</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.has_plugin" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Check if a specified plugin is installed in a given NetBox instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>plugin_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the plugin to check for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The identifier or address of the NetBox instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strict</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, raises a RuntimeError when the plugin is not found.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the plugin is installed, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">has_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a specified plugin is installed in a given NetBox instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        plugin_name (str): The name of the plugin to check for.</span>
<span class="sd">        instance (str): The identifier or address of the NetBox instance.</span>
<span class="sd">        strict (bool, optional): If True, raises a RuntimeError when the plugin is not found.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the plugin is installed, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_netbox_status</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plugin_name</span> <span class="ow">in</span> <span class="n">nb_status</span><span class="p">[</span><span class="s2">&quot;plugins&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">strict</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&#39; Netbox instance has no &#39;</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="s2">&#39; plugin installed&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.cache_list" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cache_list</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.cache_list" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve a list of cache keys, optionally with details about each key.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A pattern to match cache keys against. Defaults to "*".</p>
              </div>
            </td>
            <td>
                  <code>&#39;*&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>details</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include detailed information about each cache key. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of cache keys or a list of dictionaries with detailed information if <code>details</code> is True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve a list of cache keys, optionally with details about each key.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (str): A pattern to match cache keys against. Defaults to &quot;*&quot;.</span>
<span class="sd">        details (bool): If True, include detailed information about each cache key. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of cache keys or a list of dictionaries with detailed information if `details` is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:cache_list&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">expire_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
                <span class="n">creation</span> <span class="o">=</span> <span class="n">expires</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">)</span>
                <span class="n">age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">creation</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">cache_key</span><span class="p">,</span>
                        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">age</span><span class="p">),</span>
                        <span class="s2">&quot;creation&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">creation</span><span class="p">),</span>
                        <span class="s2">&quot;expires&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expires</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.cache_clear" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cache_clear</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.cache_clear" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Clears specified keys from the cache.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A specific key to remove from the cache.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A glob pattern to match multiple keys to remove from the cache.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of keys that were successfully removed from the cache.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a specified key or a key matching the glob pattern could not be removed from the cache.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Notes:</p>
<ul>
<li>If neither <code>key</code> nor <code>keys</code> is provided, the function will return a message indicating that there is nothing to clear.</li>
<li>If <code>key</code> is provided, it will attempt to remove that specific key from the cache.</li>
<li>If <code>keys</code> is provided, it will attempt to remove all keys matching the glob pattern from the cache.</li>
</ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clears specified keys from the cache.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        key (str, optional): A specific key to remove from the cache.</span>
<span class="sd">        keys (str, optional): A glob pattern to match multiple keys to remove from the cache.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of keys that were successfully removed from the cache.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If a specified key or a key matching the glob pattern could not be removed from the cache.</span>

<span class="sd">    Notes:</span>

<span class="sd">    - If neither `key` nor `keys` is provided, the function will return a message indicating that there is nothing to clear.</span>
<span class="sd">    - If `key` is provided, it will attempt to remove that specific key from the cache.</span>
<span class="sd">    - If `keys` is provided, it will attempt to remove all keys matching the glob pattern from the cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:cache_clear&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">[])</span>
    <span class="c1"># check if has keys to clear</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">keys</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Noting to clear, specify key or keys&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="c1"># remove specific key from cache</span>
    <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> from cache&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not in cache.&quot;</span><span class="p">)</span>
    <span class="c1"># remove all keys matching glob pattern</span>
    <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> from cache&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.cache_get" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cache_get</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">raise_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.cache_get" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve values from the cache based on a specific key or a pattern of keys.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A specific key to retrieve from the cache.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keys</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A glob pattern to match multiple keys in the cache.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raise_missing</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, raises a KeyError if the specific
key is not found in the cache. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the results of the cache retrieval. The keys are
the cache keys and the values are the corresponding cache values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If raise_missing is True and the specific key is not found in the cache.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cache_get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">raise_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve values from the cache based on a specific key or a pattern of keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        key (str, optional): A specific key to retrieve from the cache.</span>
<span class="sd">        keys (str, optional): A glob pattern to match multiple keys in the cache.</span>
<span class="sd">        raise_missing (bool, optional): If True, raises a KeyError if the specific</span>
<span class="sd">            key is not found in the cache. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the results of the cache retrieval. The keys are</span>
<span class="sd">            the cache keys and the values are the corresponding cache values.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If raise_missing is True and the specific key is not found in the cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:cache_clear&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">{})</span>
    <span class="c1"># get specific key from cache</span>
    <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">raise_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not in cache.&quot;</span><span class="p">)</span>
    <span class="c1"># get all keys matching glob pattern</span>
    <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.graphql" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">graphql</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">queries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">query_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.graphql" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Function to query Netbox v3 or Netbox v4 GraphQL API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox instance name</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>only return query content, do not run it</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>obj</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object to query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="dict">dict</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filters to apply to the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fields</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fields to retrieve in the query</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>queries</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of queries to execute</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query_string</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw query string to execute</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GraphQL request data returned by Netbox</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required arguments are not provided</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If GraphQL query fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">graphql</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">queries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">query_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to query Netbox v3 or Netbox v4 GraphQL API.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        instance: Netbox instance name</span>
<span class="sd">        dry_run: only return query content, do not run it</span>
<span class="sd">        obj: Object to query</span>
<span class="sd">        filters: Filters to apply to the query</span>
<span class="sd">        fields: Fields to retrieve in the query</span>
<span class="sd">        queries: Dictionary of queries to execute</span>
<span class="sd">        query_string: Raw query string to execute</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: GraphQL request data returned by Netbox</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If required arguments are not provided</span>
<span class="sd">        Exception: If GraphQL query fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_params</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:graphql&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">])</span>

    <span class="c1"># form graphql query(ies) payload</span>
    <span class="k">if</span> <span class="n">queries</span><span class="p">:</span>
        <span class="n">queries_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">query_data</span> <span class="ow">in</span> <span class="n">queries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query_data</span><span class="p">[</span><span class="s2">&quot;alias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">queries_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_form_query_v4</span><span class="p">(</span><span class="o">**</span><span class="n">query_data</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">queries_strings</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">queries_list</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;query </span><span class="se">{{</span><span class="si">{</span><span class="n">queries_strings</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">filters</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">_form_query_v4</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;query </span><span class="se">{{</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">query_string</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query_string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - graphql method expects quieries argument or obj, filters, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;fields arguments or query_string argument provided&quot;</span>
        <span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>

    <span class="c1"># form and return dry run response</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/graphql/&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
            <span class="s2">&quot;verify&quot;</span><span class="p">:</span> <span class="n">nb_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_verify&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Token ...</span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># send request to Netbox GraphQL API</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - sending GraphQL query &#39;</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&#39; to URL &#39;</span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/graphql/&#39;&quot;</span>
    <span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/graphql/&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
        <span class="n">verify</span><span class="o">=</span><span class="n">nb_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_verify&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">netbox_connect_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">netbox_read_timeout</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">req</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -  Netbox GraphQL query failed, query &#39;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;URL &#39;</span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;, status-code &#39;</span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&#39;, reason &#39;</span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;response content &#39;</span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># return results</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - GrapQL query error &#39;</span><span class="si">{</span><span class="n">reply</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;, query &#39;</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>  <span class="c1"># at least return some data</span>
    <span class="k">elif</span> <span class="n">queries</span> <span class="ow">or</span> <span class="n">query_string</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="n">obj</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.rest" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rest</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.rest" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Sends a request to the Netbox REST API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Netbox instance name to get parameters for.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The HTTP method to use for the request (e.g., 'get', 'post'). Defaults to "get".</p>
              </div>
            </td>
            <td>
                  <code>&#39;get&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The API endpoint to send the request to. Defaults to "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments to pass to the request (e.g., params, data, json).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union[dict, list]: The JSON response from the API, parsed into a dictionary or list.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="requests.exceptions.HTTPError">HTTPError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the HTTP request returned an unsuccessful status code.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rest</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span>
    <span class="n">api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends a request to the Netbox REST API.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance (str, optional): The Netbox instance name to get parameters for.</span>
<span class="sd">        method (str, optional): The HTTP method to use for the request (e.g., &#39;get&#39;, &#39;post&#39;). Defaults to &quot;get&quot;.</span>
<span class="sd">        api (str, optional): The API endpoint to send the request to. Defaults to &quot;&quot;.</span>
<span class="sd">        **kwargs: Additional arguments to pass to the request (e.g., params, data, json).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[dict, list]: The JSON response from the API, parsed into a dictionary or list.</span>

<span class="sd">    Raises:</span>
<span class="sd">        requests.exceptions.HTTPError: If the HTTP request returned an unsuccessful status code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:rest&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">nb_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_params</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="c1"># send request to Netbox REST API</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span>
        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/api/</span><span class="si">{</span><span class="n">api</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">nb_params</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">verify</span><span class="o">=</span><span class="n">nb_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_verify&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode json, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_devices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_devices</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_devices" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieves device data from Netbox using the GraphQL API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of filter dictionaries to filter devices.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Netbox instance name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only returns the query content without executing it. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of device names to query data for.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cache usage options:</p>
<ul>
<li>True: Use data stored in cache if it is up to date, refresh it otherwise.</li>
<li>False: Do not use cache and do not update cache.</li>
<li>"refresh": Ignore data in cache and replace it with data fetched from Netbox.</li>
<li>"force": Use data in cache without checking if it is up to date.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary keyed by device name with device data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the GraphQL query fails or if there are errors in the query result.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_devices</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves device data from Netbox using the GraphQL API.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        filters (list, optional): A list of filter dictionaries to filter devices.</span>
<span class="sd">        instance (str, optional): The Netbox instance name.</span>
<span class="sd">        dry_run (bool, optional): If True, only returns the query content without executing it. Defaults to False.</span>
<span class="sd">        devices (list, optional): A list of device names to query data for.</span>
<span class="sd">        cache (Union[bool, str], optional): Cache usage options:</span>

<span class="sd">            - True: Use data stored in cache if it is up to date, refresh it otherwise.</span>
<span class="sd">            - False: Do not use cache and do not update cache.</span>
<span class="sd">            - &quot;refresh&quot;: Ignore data in cache and replace it with data fetched from Netbox.</span>
<span class="sd">            - &quot;force&quot;: Use data in cache without checking if it is up to date.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary keyed by device name with device data.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If the GraphQL query fails or if there are errors in the query result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_devices&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">{},</span> <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">])</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_use</span> <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># devices queries</span>
    <span class="n">device_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;custom_field_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device_type </span><span class="si">{model}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;role </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config_context&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tenant </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;serial&quot;</span><span class="p">,</span>
        <span class="s2">&quot;asset_tag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;site {name slug tags</span><span class="si">{name}</span><span class="s2"> }&quot;</span><span class="p">,</span>
        <span class="s2">&quot;location </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rack </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;primary_ip4 </span><span class="si">{address}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;primary_ip6 </span><span class="si">{address}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;airflow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;position&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span><span class="p">:</span>
        <span class="c1"># retrieve last updated data from Netbox for devices</span>
        <span class="n">last_updated_query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;devices_by_filter_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;device_list&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filter_item</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">filter_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">devices</span><span class="p">:</span>
            <span class="c1"># use cache data without checking if it is up to date for cached devices</span>
            <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
                    <span class="n">device_cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;get_devices::</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">device_cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                        <span class="n">devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">device_name</span><span class="p">)</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">device_cache_key</span><span class="p">]</span>
            <span class="c1"># query netbox last updated data for devices</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">dlist</span> <span class="o">=</span> <span class="s1">&#39;[&quot;</span><span class="si">{dl}</span><span class="s1">&quot;]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span>
                <span class="n">filters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">in_list: </span><span class="si">{</span><span class="n">dlist</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">last_updated_query</span><span class="p">[</span><span class="s2">&quot;devices_by_devices_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;device_list&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters_dict</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_updated&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="n">last_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">queries</span><span class="o">=</span><span class="n">last_updated_query</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">last_updated</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - get devices query failed&quot;</span><span class="p">)</span>

        <span class="c1"># return dry run result</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;get_devices_dry_run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_updated</span><span class="o">.</span><span class="n">result</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="c1"># try to retrieve device data from cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>  <span class="c1"># remove expired items from cache</span>
        <span class="k">for</span> <span class="n">devices_list</span> <span class="ow">in</span> <span class="n">last_updated</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices_list</span><span class="p">:</span>
                <span class="n">device_cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;get_devices::</span><span class="si">{</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># check if cache is up to date and use it if so</span>
                <span class="k">if</span> <span class="n">device_cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">device_cache_key</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                    <span class="o">==</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span>
                <span class="p">):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">device_cache_key</span><span class="p">]</span>
                    <span class="c1"># remove device from list of devices to retrieve</span>
                    <span class="k">if</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
                        <span class="n">devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="c1"># cache old or no cache, fetch device data</span>
                <span class="k">elif</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
    <span class="c1"># ignore cache data, fetch data from netbox</span>
    <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;devices_by_filter_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;device_list&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filter_item</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">device_fields</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">filter_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="c1"># fetch devices data from Netbox</span>
    <span class="k">if</span> <span class="n">devices</span> <span class="ow">or</span> <span class="n">queries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">dlist</span> <span class="o">=</span> <span class="s1">&#39;[&quot;</span><span class="si">{dl}</span><span class="s1">&quot;]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="s1">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span>
                <span class="n">filters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">in_list: </span><span class="si">{</span><span class="n">dlist</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">queries</span><span class="p">[</span><span class="s2">&quot;devices_by_devices_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;device_list&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters_dict</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">device_fields</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># send queries</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span>
        <span class="p">)</span>

        <span class="c1"># check for errors</span>
        <span class="k">if</span> <span class="n">query_result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - get devices query failed with errors:</span><span class="se">\n</span><span class="si">{</span><span class="n">query_result</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># return dry run result</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;get_devices_dry_run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">result</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="c1"># process devices data</span>
        <span class="n">devices_data</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">result</span>
        <span class="k">for</span> <span class="n">devices_list</span> <span class="ow">in</span> <span class="n">devices_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                    <span class="n">device_name</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="c1"># cache device data</span>
                    <span class="k">if</span> <span class="n">cache</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;get_devices::</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">)</span>
                    <span class="c1"># add device data to return result</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_interfaces" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_interfaces</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inventory_items</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_interfaces" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve device interfaces from Netbox using GraphQL API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox instance name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of devices to retrieve interfaces for.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface_regex</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regex patter to match interfaces by name, case insensitive.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ip_addresses</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, retrieves interface IPs. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inventory_items</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, retrieves interface inventory items. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only return query content, do not run it. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary keyed by device name with interface details.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no interfaces data is returned for the specified devices.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_interfaces</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">inventory_items</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve device interfaces from Netbox using GraphQL API.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        instance (str, optional): Netbox instance name.</span>
<span class="sd">        devices (list, optional): List of devices to retrieve interfaces for.</span>
<span class="sd">        interface_regex (str, optional): Regex patter to match interfaces by name, case insensitive.</span>
<span class="sd">        ip_addresses (bool, optional): If True, retrieves interface IPs. Defaults to False.</span>
<span class="sd">        inventory_items (bool, optional): If True, retrieves interface inventory items. Defaults to False.</span>
<span class="sd">        dry_run (bool, optional): If True, only return query content, do not run it. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary keyed by device name with interface details.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If no interfaces data is returned for the specified devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_interfaces&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">intf_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enabled&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mtu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parent </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;untagged_vlan {vid name}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vrf </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tagged_vlans {vid name}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;custom_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bridge </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;child_interfaces </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bridge_interfaces </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;member_interfaces </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wwn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duplex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;speed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mark_connected&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">intf_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mac_addresses </span><span class="si">{mac_address}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># add IP addresses to interfaces fields</span>
    <span class="k">if</span> <span class="n">ip_addresses</span><span class="p">:</span>
        <span class="n">intf_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;ip_addresses {address status role dns_name description custom_fields last_updated tenant </span><span class="si">{name}</span><span class="s2"> tags </span><span class="si">{name}</span><span class="s2">}&quot;</span>
        <span class="p">)</span>

    <span class="c1"># form interfaces query dictionary</span>
    <span class="n">dlist</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># add interface name regex filter</span>
        <span class="k">if</span> <span class="n">interface_regex</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;{device: {name: {in_list: &quot;</span>
                <span class="o">+</span> <span class="n">dlist</span>
                <span class="o">+</span> <span class="s2">&quot;}}&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, name: {i_regex: &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">interface_regex</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="o">+</span> <span class="s2">&quot;}}&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="s2">&quot;{device: {name: {in_list: &quot;</span> <span class="o">+</span> <span class="n">dlist</span> <span class="o">+</span> <span class="s2">&quot;}}}&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">queries</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;interfaces&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;interface_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">intf_fields</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># add query to retrieve inventory items</span>
    <span class="k">if</span> <span class="n">inventory_items</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
            <span class="n">inv_filters</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;{device: {name: {in_list: &quot;</span>
                <span class="o">+</span> <span class="n">dlist</span>
                <span class="o">+</span> <span class="s1">&#39;}}, component_type: {app_label: {exact: &quot;dcim&quot;}}}&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">inv_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;component {... on InterfaceType </span><span class="si">{id}</span><span class="s2">}&quot;</span><span class="p">,</span>
            <span class="s2">&quot;role </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;manufacturer </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;custom_fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tags </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;asset_tag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;serial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;part_id&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">queries</span><span class="p">[</span><span class="s2">&quot;inventor_items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;inventory_item_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">inv_filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">inv_fields</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span>
    <span class="p">)</span>

    <span class="c1"># return dry run result</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_result</span>

    <span class="n">interfaces_data</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">result</span>

    <span class="c1"># exit if no Interfaces returned</span>
    <span class="k">if</span> <span class="n">interfaces_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">interfaces_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interfaces&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - no interfaces data in &#39;</span><span class="si">{</span><span class="n">interfaces_data</span><span class="si">}</span><span class="s2">&#39; returned by &#39;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;for devices </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># process query results</span>
    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">interfaces_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;interfaces&quot;</span><span class="p">)</span>

    <span class="c1"># process inventory items</span>
    <span class="k">if</span> <span class="n">inventory_items</span><span class="p">:</span>
        <span class="n">inventory_items_list</span> <span class="o">=</span> <span class="n">interfaces_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;inventor_items&quot;</span><span class="p">)</span>
        <span class="c1"># transform inventory items list to a dictionary keyed by intf_id</span>
        <span class="n">inventory_items_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="n">inventory_items_list</span><span class="p">:</span>
            <span class="n">inv_item</span> <span class="o">=</span> <span class="n">inventory_items_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># skip inventory items that does not assigned to components</span>
            <span class="k">if</span> <span class="n">inv_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">intf_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">inv_item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
            <span class="n">inventory_items_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">intf_id</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">inventory_items_dict</span><span class="p">[</span><span class="n">intf_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inv_item</span><span class="p">)</span>
        <span class="c1"># iterate over interfaces and add inventory items</span>
        <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="n">intf</span><span class="p">[</span><span class="s2">&quot;inventory_items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inventory_items_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">intf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">[])</span>

    <span class="c1"># transform interfaces list to dictionary keyed by device and interfaces names</span>
    <span class="k">while</span> <span class="n">interfaces</span><span class="p">:</span>
        <span class="n">intf</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">device_name</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">intf_name</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>  <span class="c1"># Netbox issue #16299</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="n">intf_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">intf</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_connections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_connections</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include_virtual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_connections" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve interface connection details for specified devices from Netbox.</p>
<p>This task retrieves these connections:</p>
<ul>
<li>Physical interfaces connections</li>
<li>Child/virtual interfaces connections using parent interface connections details</li>
<li>Lag interfaces connections using member ports connections details</li>
<li>Lag child interfaces connections using member ports connections details</li>
<li>Console port and console server ports connections</li>
<li>Connections to provider networks for physical, child/virtual and lag interfaces</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of device names to retrieve connections for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox instance name for the GraphQL query.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, perform a dry run without making actual changes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cables</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True includes interfaces' directly attached cables details</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_virtual</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True include connections for virtual and LAG interfaces</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface_regex</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regex patter to match interfaces, console ports and
console server ports by name, case insensitive.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing connection details for each device:</p>
<div class="highlight"><pre><span></span><code>{
    &quot;netbox-worker-1.2&quot;: {
        &quot;r1&quot;: {
            &quot;Console&quot;: {
                &quot;breakout&quot;: false,
                &quot;remote_device&quot;: &quot;termserv1&quot;,
                &quot;remote_device_status&quot;: &quot;active&quot;,
                &quot;remote_interface&quot;: &quot;ConsoleServerPort1&quot;,
                &quot;remote_termination_type&quot;: &quot;consoleserverport&quot;,
                &quot;termination_type&quot;: &quot;consoleport&quot;
            },
            &quot;eth1&quot;: {
                &quot;breakout&quot;: false,
                &quot;remote_device&quot;: &quot;r2&quot;,
                &quot;remote_device_status&quot;: &quot;active&quot;,
                &quot;remote_interface&quot;: &quot;eth8&quot;,
                &quot;remote_termination_type&quot;: &quot;interface&quot;,
                &quot;termination_type&quot;: &quot;interface&quot;
            }
        }
    }
}
</code></pre></div>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there is an error in the GraphQL query or data retrieval process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_connections</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_virtual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve interface connection details for specified devices from Netbox.</span>

<span class="sd">    This task retrieves these connections:</span>

<span class="sd">    - Physical interfaces connections</span>
<span class="sd">    - Child/virtual interfaces connections using parent interface connections details</span>
<span class="sd">    - Lag interfaces connections using member ports connections details</span>
<span class="sd">    - Lag child interfaces connections using member ports connections details</span>
<span class="sd">    - Console port and console server ports connections</span>
<span class="sd">    - Connections to provider networks for physical, child/virtual and lag interfaces</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        devices (list): List of device names to retrieve connections for.</span>
<span class="sd">        instance (str, optional): Netbox instance name for the GraphQL query.</span>
<span class="sd">        dry_run (bool, optional): If True, perform a dry run without making actual changes.</span>
<span class="sd">        cables (bool, optional): if True includes interfaces&#39; directly attached cables details</span>
<span class="sd">        include_virtual (bool, optional): if True include connections for virtual and LAG interfaces</span>
<span class="sd">        interface_regex (str, optional): Regex patter to match interfaces, console ports and</span>
<span class="sd">            console server ports by name, case insensitive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing connection details for each device:</span>

<span class="sd">            ```</span>
<span class="sd">            {</span>
<span class="sd">                &quot;netbox-worker-1.2&quot;: {</span>
<span class="sd">                    &quot;r1&quot;: {</span>
<span class="sd">                        &quot;Console&quot;: {</span>
<span class="sd">                            &quot;breakout&quot;: false,</span>
<span class="sd">                            &quot;remote_device&quot;: &quot;termserv1&quot;,</span>
<span class="sd">                            &quot;remote_device_status&quot;: &quot;active&quot;,</span>
<span class="sd">                            &quot;remote_interface&quot;: &quot;ConsoleServerPort1&quot;,</span>
<span class="sd">                            &quot;remote_termination_type&quot;: &quot;consoleserverport&quot;,</span>
<span class="sd">                            &quot;termination_type&quot;: &quot;consoleport&quot;</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;eth1&quot;: {</span>
<span class="sd">                            &quot;breakout&quot;: false,</span>
<span class="sd">                            &quot;remote_device&quot;: &quot;r2&quot;,</span>
<span class="sd">                            &quot;remote_device_status&quot;: &quot;active&quot;,</span>
<span class="sd">                            &quot;remote_interface&quot;: &quot;eth8&quot;,</span>
<span class="sd">                            &quot;remote_termination_type&quot;: &quot;interface&quot;,</span>
<span class="sd">                            &quot;termination_type&quot;: &quot;interface&quot;</span>
<span class="sd">                        }</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If there is an error in the GraphQL query or data retrieval process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_connections&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># form lists of fields to request from netbox</span>
    <span class="n">cable_fields</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        cable {</span>
<span class="s2">            type</span>
<span class="s2">            status</span>
<span class="s2">            tenant </span><span class="si">{name}</span>
<span class="s2">            label</span>
<span class="s2">            tags </span><span class="si">{name}</span>
<span class="s2">            length</span>
<span class="s2">            length_unit</span>
<span class="s2">            custom_fields</span>
<span class="s2">        }</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">interfaces_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device {name, status}&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        member_interfaces {</span>
<span class="sd">          name</span>
<span class="sd">          connected_endpoints {</span>
<span class="sd">            __typename</span>
<span class="sd">            ... on ProviderNetworkType {name}</span>
<span class="sd">            ... on InterfaceType {name, device {name, status}, child_interfaces {name}, lag {name child_interfaces {name}}}</span>
<span class="sd">          }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parent {</span>
<span class="sd">          name</span>
<span class="sd">          type</span>
<span class="sd">          member_interfaces {</span>
<span class="sd">            name</span>
<span class="sd">            connected_endpoints {</span>
<span class="sd">              __typename</span>
<span class="sd">              ... on ProviderNetworkType {name}</span>
<span class="sd">              ... on InterfaceType {name, device {name, status}, child_interfaces {name}, lag {name child_interfaces {name}}}</span>
<span class="sd">            }</span>
<span class="sd">          }</span>
<span class="sd">          connected_endpoints {</span>
<span class="sd">            __typename</span>
<span class="sd">            ... on ProviderNetworkType {name}</span>
<span class="sd">            ... on InterfaceType {name, device {name, status}, child_interfaces {name}, lag {name child_interfaces {name}}}</span>
<span class="sd">          }</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        connected_endpoints {</span>
<span class="sd">            __typename </span>
<span class="sd">            ... on ProviderNetworkType {name}</span>
<span class="sd">            ... on InterfaceType {name, device {name, status}, child_interfaces {name}, lag {name child_interfaces {name}}}</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">interfaces_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        link_peers {</span>
<span class="sd">            __typename</span>
<span class="sd">            ... on InterfaceType {name device {name, status}}</span>
<span class="sd">            ... on FrontPortType {name device {name, status}}</span>
<span class="sd">            ... on RearPortType {name device {name, status}}</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">console_ports_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device {name, status}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connected_endpoints {</span>
<span class="sd">          __typename </span>
<span class="sd">          ... on ConsoleServerPortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;link_peers {</span>
<span class="sd">          __typename</span>
<span class="sd">          ... on ConsoleServerPortType {name device {name, status}}</span>
<span class="sd">          ... on FrontPortType {name device {name, status}}</span>
<span class="sd">          ... on RearPortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">console_server_ports_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device {name, status}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connected_endpoints {</span>
<span class="sd">          __typename </span>
<span class="sd">          ... on ConsolePortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;link_peers {</span>
<span class="sd">          __typename</span>
<span class="sd">          ... on ConsolePortType {name device {name, status}}</span>
<span class="sd">          ... on FrontPortType {name device {name, status}}</span>
<span class="sd">          ... on RearPortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">power_outlet_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;device {name, status}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connected_endpoints {</span>
<span class="sd">          __typename </span>
<span class="sd">          ... on PowerPortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;link_peers {</span>
<span class="sd">          __typename</span>
<span class="sd">          ... on PowerPortType {name device {name, status}}</span>
<span class="sd">        }&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># check if need to include cables info</span>
    <span class="k">if</span> <span class="n">cables</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">interfaces_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cable_fields</span><span class="p">)</span>
        <span class="n">console_ports_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cable_fields</span><span class="p">)</span>
        <span class="n">console_server_ports_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cable_fields</span><span class="p">)</span>
        <span class="n">power_outlet_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cable_fields</span><span class="p">)</span>

    <span class="c1"># form query dictionary with aliases to get data from Netbox</span>
    <span class="n">dlist</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">interface_regex</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;{device: {name: {in_list: &quot;</span>
                <span class="o">+</span> <span class="n">dlist</span>
                <span class="o">+</span> <span class="s2">&quot;}}, &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;name: {i_regex: &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">interface_regex</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="o">+</span> <span class="s2">&quot;}}&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="s2">&quot;{device: {name: {in_list: &quot;</span> <span class="o">+</span> <span class="n">dlist</span> <span class="o">+</span> <span class="s2">&quot;}}}&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">queries</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;interface_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">interfaces_fields</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;consoleport&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;console_port_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">console_ports_fields</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;consoleserverport&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;console_server_port_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">console_server_ports_fields</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;poweroutlet&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;obj&quot;</span><span class="p">:</span> <span class="s2">&quot;power_outlet_list&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">power_outlet_fields</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># retrieve full list of devices interface with all cables</span>
    <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span>
    <span class="p">)</span>

    <span class="c1"># return dry run result</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query_result</span>

    <span class="n">all_ports</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">result</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_ports</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># extract physical interfaces connections</span>
    <span class="k">for</span> <span class="n">port_type</span><span class="p">,</span> <span class="n">ports</span> <span class="ow">in</span> <span class="n">all_ports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="c1"># skip ports that have no remote device connected</span>
            <span class="n">endpoints</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;connected_endpoints&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoints</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># extract required parameters</span>
            <span class="n">cable</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cable&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">device_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">port_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">link_peers</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;link_peers&quot;</span><span class="p">]</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">remote_termination_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># form initial connection dictionary</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;breakout&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;remote_termination_type&quot;</span><span class="p">:</span> <span class="n">remote_termination_type</span><span class="p">,</span>
                <span class="s2">&quot;termination_type&quot;</span><span class="p">:</span> <span class="n">port_type</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># add remote connection details</span>
            <span class="k">if</span> <span class="n">remote_termination_type</span> <span class="o">==</span> <span class="s2">&quot;providernetwork&quot;</span><span class="p">:</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;provider&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remote_interface</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">remote_interface</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">]))</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote_interface</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;status&quot;</span>
                <span class="p">]</span>

            <span class="c1"># add cable and its peer details</span>
            <span class="k">if</span> <span class="n">cables</span><span class="p">:</span>
                <span class="n">peer_termination_type</span> <span class="o">=</span> <span class="n">link_peers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">peer_termination_type</span> <span class="o">=</span> <span class="n">peer_termination_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">cable</span><span class="p">[</span><span class="s2">&quot;peer_termination_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_termination_type</span>
                <span class="n">cable</span><span class="p">[</span><span class="s2">&quot;peer_device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link_peers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">cable</span><span class="p">[</span><span class="s2">&quot;peer_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link_peers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link_peers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># handle breakout cable</span>
                    <span class="n">cable</span><span class="p">[</span><span class="s2">&quot;peer_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">link_peers</span><span class="p">]</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;cable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cable</span>

            <span class="c1"># add physical connection to the results</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="n">port_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="c1"># extract virtual interfaces connections</span>
    <span class="k">for</span> <span class="n">port_type</span><span class="p">,</span> <span class="n">ports</span> <span class="ow">in</span> <span class="n">all_ports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="c1"># add child virtual interfaces connections</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">include_virtual</span>
                <span class="ow">or</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;virtual&quot;</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">device_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">interface_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;remote_device&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_device_status&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_interface&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_termination_type&quot;</span><span class="p">:</span> <span class="s2">&quot;virtual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;termination_type&quot;</span><span class="p">:</span> <span class="s2">&quot;virtual&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># find connection endpoint</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lag&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;member_interfaces&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span>
                        <span class="s2">&quot;connected_endpoints&quot;</span>
                    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;connected_endpoints&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;connected_endpoints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">remote_termination_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># collect virtual interfaces facing provider</span>
            <span class="k">if</span> <span class="n">remote_termination_type</span> <span class="o">==</span> <span class="s2">&quot;providernetwork&quot;</span><span class="p">:</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;provider&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="c1"># find matching remote virtual interface for LAG subif</span>
            <span class="k">elif</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">interface_name</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lag&quot;</span><span class="p">:</span>
                <span class="n">subif_id</span> <span class="o">=</span> <span class="n">interface_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">remote_child</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;lag&quot;</span><span class="p">][</span><span class="s2">&quot;child_interfaces&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">remote_child</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">subif_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote_child</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="c1"># no matching subinterface found, associate child interface with remote interface</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;lag&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_termination_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lag&quot;</span>
            <span class="c1"># find matching remote virtual interface for physical interface subif</span>
            <span class="k">elif</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">interface_name</span><span class="p">:</span>
                <span class="n">subif_id</span> <span class="o">=</span> <span class="n">interface_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">remote_child</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;child_interfaces&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">remote_child</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">subif_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote_child</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="c1"># no matching subinterface found, associate child interface with remote interface</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_termination_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote_termination_type</span>
            <span class="c1"># add virtual interface connection to results</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="n">interface_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="c1"># extract LAG interfaces connections</span>
    <span class="k">for</span> <span class="n">port_type</span><span class="p">,</span> <span class="n">ports</span> <span class="ow">in</span> <span class="n">all_ports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_virtual</span> <span class="ow">or</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;lag&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">device_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">interface_name</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;remote_device&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_device_status&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_interface&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote_termination_type&quot;</span><span class="p">:</span> <span class="s2">&quot;lag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;termination_type&quot;</span><span class="p">:</span> <span class="s2">&quot;lag&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="s2">&quot;member_interfaces&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;connected_endpoints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;__typename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">remote_termination_type</span> <span class="o">=</span> <span class="n">remote_termination_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># collect lag interfaces facing provider</span>
            <span class="k">if</span> <span class="n">remote_termination_type</span> <span class="o">==</span> <span class="s2">&quot;providernetwork&quot;</span><span class="p">:</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;provider&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="c1"># find remote lag interface</span>
            <span class="k">elif</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;lag&quot;</span><span class="p">]:</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;lag&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="c1"># add lag interface connection to results</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="n">interface_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_circuits" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_circuits</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">cid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_circuits" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve circuit information for specified devices from Netbox.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of device names to retrieve circuits for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cid</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of circuit IDs to filter by.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox instance to query.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, perform a dry run without making changes. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cache usage options:</p>
<ul>
<li>True: Use data stored in cache if it is up to date, refresh it otherwise.</li>
<li>False: Do not use cache and do not update cache.</li>
<li>"refresh": Ignore data in cache and replace it with data fetched from Netbox.</li>
<li>"force": Use data in cache without checking if it is up to date.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary keyed by device names with circuits data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Task to retrieve device's circuits data from Netbox.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_circuits</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">cid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve circuit information for specified devices from Netbox.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        devices (list): List of device names to retrieve circuits for.</span>
<span class="sd">        cid (list, optional): List of circuit IDs to filter by.</span>
<span class="sd">        instance (str, optional): Netbox instance to query.</span>
<span class="sd">        dry_run (bool, optional): If True, perform a dry run without making changes. Defaults to False.</span>
<span class="sd">        cache (Union[bool, str], optional): Cache usage options:</span>

<span class="sd">            - True: Use data stored in cache if it is up to date, refresh it otherwise.</span>
<span class="sd">            - False: Do not use cache and do not update cache.</span>
<span class="sd">            - &quot;refresh&quot;: Ignore data in cache and replace it with data fetched from Netbox.</span>
<span class="sd">            - &quot;force&quot;: Use data in cache without checking if it is up to date.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: dictionary keyed by device names with circuits data.</span>

<span class="sd">    Task to retrieve device&#39;s circuits data from Netbox.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - </span><span class="si">{</span><span class="n">instance</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span><span class="si">}</span><span class="s2"> Netbox, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;devices </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s2">, cid </span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>

    <span class="c1"># form final result object</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_use</span> <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">circuit_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;cid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;provider </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;commit_rate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;provider_account </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tenant </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;termination_a {id last_updated}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;termination_z {id last_updated}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;custom_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comments&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># form initial circuits filters based on devices&#39; sites and cid list</span>
    <span class="n">circuits_filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">device_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span>
    <span class="p">)</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">][</span><span class="s2">&quot;slug&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">device_data</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">slist</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
        <span class="k">if</span> <span class="n">cid</span><span class="p">:</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
            <span class="n">circuits_filters</span> <span class="o">=</span> <span class="s2">&quot;{terminations: {site: {slug: {in_list: slist}}}, cid: {in_list: clist}}&quot;</span>
            <span class="n">circuits_filters</span> <span class="o">=</span> <span class="n">circuits_filters</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;slist&quot;</span><span class="p">,</span> <span class="n">slist</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;clist&quot;</span><span class="p">,</span> <span class="n">clist</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">circuits_filters</span> <span class="o">=</span> <span class="s2">&quot;{terminations: {site: {slug: {in_list: slist }}}}&quot;</span>
            <span class="n">circuits_filters</span> <span class="o">=</span> <span class="n">circuits_filters</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;slist&quot;</span><span class="p">,</span> <span class="n">slist</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - constructed circuits filters: &#39;</span><span class="si">{</span><span class="n">circuits_filters</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - retrieving circuits data from cache&quot;</span><span class="p">)</span>
        <span class="n">cid_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#  new cid list for follow up query</span>
        <span class="c1"># retrieve last updated data from Netbox for circuits and their terminations</span>
        <span class="n">last_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="s2">&quot;circuit_list&quot;</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">circuits_filters</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;cid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;last_updated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;termination_a {id last_updated}&quot;</span><span class="p">,</span>
                <span class="s2">&quot;termination_z {id last_updated}&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">last_updated</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - get circuits query failed&quot;</span><span class="p">)</span>

        <span class="c1"># return dry run result</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;get_circuits_dry_run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_updated</span><span class="o">.</span><span class="n">result</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="c1"># retrieve circuits data from cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>  <span class="c1"># remove expired items from cache</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">last_updated</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="n">circuit_cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;get_circuits::</span><span class="si">{</span><span class="n">circuit</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - searching cache for key </span><span class="si">{</span><span class="n">circuit_cache_key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># check if cache is up to date and use it if so</span>
                <span class="k">if</span> <span class="n">circuit_cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                    <span class="n">cache_ckt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">circuit_cache_key</span><span class="p">]</span>
                    <span class="c1"># check if device uses this circuit</span>
                    <span class="k">if</span> <span class="n">device</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache_ckt</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># use cache forcefully</span>
                    <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span><span class="p">:</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">]</span>
                    <span class="c1"># check circuit cache is up to date</span>
                    <span class="k">if</span> <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;termination_a&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;termination_a&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;termination_a&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                        <span class="o">!=</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;termination_a&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;termination_z&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;termination_z&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;termination_z&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                        <span class="o">!=</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;termination_z&quot;</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cache_ckt</span><span class="p">[</span><span class="n">device</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - </span><span class="si">{</span><span class="n">circuit</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> retrieved data from cache&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cid_list</span><span class="p">:</span>
                    <span class="n">cid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">])</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - </span><span class="si">{</span><span class="n">circuit</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> no cache data found, fetching from Netbox&quot;</span>
                    <span class="p">)</span>
        <span class="c1"># form new filters dictionary to fetch remaining circuits data</span>
        <span class="n">circuits_filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cid_list</span><span class="p">:</span>
            <span class="n">cid_list</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cid_list</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># swap quotes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">circuits_filters</span> <span class="o">=</span> <span class="s2">&quot;{cid: {in_list: cid_list}}&quot;</span>
                <span class="n">circuits_filters</span> <span class="o">=</span> <span class="n">circuits_filters</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cid_list&quot;</span><span class="p">,</span> <span class="n">cid_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    <span class="c1"># ignore cache data, fetch circuits from netbox</span>
    <span class="k">elif</span> <span class="n">cache</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">circuits_filters</span><span class="p">:</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">=</span><span class="s2">&quot;circuit_list&quot;</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">circuits_filters</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="n">circuit_fields</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">query_result</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - get circuits query failed&quot;</span><span class="p">)</span>

        <span class="c1"># return dry run result</span>
        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_result</span>

        <span class="n">all_circuits</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">result</span>

        <span class="c1"># iterate over circuits and map them to devices</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_circuits - retrieved data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_circuits</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;circuits from netbox, mapping circuits to devices&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_map_circuit</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">circuit</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">cache</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">all_circuits</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_nornir_inventory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_nornir_inventory</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">connections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">circuits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nbdata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">bgp_peerings</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">primary_ip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ip4&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_inventory" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve and construct Nornir inventory from NetBox data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of filters to apply when retrieving devices from NetBox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specific devices to retrieve from NetBox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox instance to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interfaces</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="dict">dict</span>, <span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include interfaces data
    in the inventory. If a dict, use it as arguments for the get_interfaces method.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>connections</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="dict">dict</span>, <span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include connections data
    in the inventory. If a dict, use it as arguments for the get_connections method.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>circuits</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="dict">dict</span>, <span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include circuits data in the
    inventory. If a dict, use it as arguments for the get_circuits method.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbdata</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include a copy of NetBox device's data in the host's data.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>primary_ip</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specify whether to use 'ip4' or 'ip6' for the primary
    IP address. Defaults to 'ip4'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;ip4&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nornir inventory dictionary containing hosts and their respective data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_nornir_inventory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interfaces</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">connections</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">circuits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">nbdata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">bgp_peerings</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">primary_ip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ip4&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve and construct Nornir inventory from NetBox data.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        filters (list, optional): List of filters to apply when retrieving devices from NetBox.</span>
<span class="sd">        devices (list, optional): List of specific devices to retrieve from NetBox.</span>
<span class="sd">        instance (str, optional): NetBox instance to use.</span>
<span class="sd">        interfaces (Union[dict, bool], optional): If True, include interfaces data</span>
<span class="sd">                in the inventory. If a dict, use it as arguments for the get_interfaces method.</span>
<span class="sd">        connections (Union[dict, bool], optional): If True, include connections data</span>
<span class="sd">                in the inventory. If a dict, use it as arguments for the get_connections method.</span>
<span class="sd">        circuits (Union[dict, bool], optional): If True, include circuits data in the</span>
<span class="sd">                inventory. If a dict, use it as arguments for the get_circuits method.</span>
<span class="sd">        nbdata (bool, optional): If True, include a copy of NetBox device&#39;s data in the host&#39;s data.</span>
<span class="sd">        primary_ip (str, optional): Specify whether to use &#39;ip4&#39; or &#39;ip6&#39; for the primary</span>
<span class="sd">                IP address. Defaults to &#39;ip4&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Nornir inventory dictionary containing hosts and their respective data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hosts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">inventory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="n">hosts</span><span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_nornir_inventory&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">inventory</span><span class="p">)</span>

    <span class="c1"># check Netbox status</span>
    <span class="n">netbox_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_netbox_status</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">netbox_status</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># retrieve devices data</span>
    <span class="n">nb_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
    <span class="p">)</span>

    <span class="c1"># form Nornir hosts inventory</span>
    <span class="k">for</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">nb_devices</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;config_context&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nornir&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">host</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">)</span>
        <span class="n">hosts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span>
        <span class="c1"># add platform if not provided in device config context</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;platform&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]:</span>
                <span class="n">host</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - no platform found for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; device&quot;</span><span class="p">)</span>
        <span class="c1"># add hostname if not provided in config context</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">host</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hostname&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;primary_ip4&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">primary_ip</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ip4&quot;</span><span class="p">,</span> <span class="s2">&quot;ipv4&quot;</span><span class="p">]:</span>
                <span class="n">host</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;primary_ip4&quot;</span><span class="p">][</span><span class="s2">&quot;address&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;primary_ip6&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">primary_ip</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ip6&quot;</span><span class="p">,</span> <span class="s2">&quot;ipv6&quot;</span><span class="p">]:</span>
                <span class="n">host</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;primary_ip6&quot;</span><span class="p">][</span><span class="s2">&quot;address&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">host</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># add netbox data to host&#39;s data</span>
        <span class="k">if</span> <span class="n">nbdata</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">host</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># return if no hosts found for provided parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - no viable hosts returned by Netbox&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># add interfaces data</span>
    <span class="k">if</span> <span class="n">interfaces</span><span class="p">:</span>
        <span class="c1"># decide on get_interfaces arguments</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">interfaces</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interfaces</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># add &#39;interfaces&#39; key to all hosts&#39; data</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">host</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;interfaces&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># query interfaces data from netbox</span>
        <span class="n">nb_interfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interfaces</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">hosts</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># save interfaces data to hosts&#39; inventory</span>
        <span class="k">while</span> <span class="n">nb_interfaces</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">device</span><span class="p">,</span> <span class="n">device_interfaces</span> <span class="o">=</span> <span class="n">nb_interfaces</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">hosts</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;interfaces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_interfaces</span>

    <span class="c1"># add connections data</span>
    <span class="k">if</span> <span class="n">connections</span><span class="p">:</span>
        <span class="c1"># decide on get_interfaces arguments</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">connections</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connections</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># add &#39;connections&#39; key to all hosts&#39; data</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">host</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;connections&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># query connections data from netbox</span>
        <span class="n">nb_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">hosts</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># save connections data to hosts&#39; inventory</span>
        <span class="k">while</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">device</span><span class="p">,</span> <span class="n">device_connections</span> <span class="o">=</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">hosts</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;connections&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_connections</span>

    <span class="c1"># add circuits data</span>
    <span class="k">if</span> <span class="n">circuits</span><span class="p">:</span>
        <span class="c1"># decide on get_interfaces arguments</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">circuits</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">circuits</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># add &#39;circuits&#39; key to all hosts&#39; data</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">host</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;circuits&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># query circuits data from netbox</span>
        <span class="n">nb_circuits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circuits</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">hosts</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># save circuits data to hosts&#39; inventory</span>
        <span class="k">while</span> <span class="n">nb_circuits</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">device</span><span class="p">,</span> <span class="n">device_circuits</span> <span class="o">=</span> <span class="n">nb_circuits</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">hosts</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;circuits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_circuits</span>

    <span class="c1"># add bgp peerings data</span>
    <span class="k">if</span> <span class="n">bgp_peerings</span><span class="p">:</span>
        <span class="c1"># decide on get_interfaces arguments</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">bgp_peerings</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bgp_peerings</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># add &#39;bgp_peerings&#39; key to all hosts&#39; data</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">host</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bgp_peerings&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># query bgp_peerings data from netbox</span>
        <span class="n">nb_bgp_peerings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bgp_peerings</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">hosts</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># save circuits data to hosts&#39; inventory</span>
        <span class="k">while</span> <span class="n">nb_bgp_peerings</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">device</span><span class="p">,</span> <span class="n">device_bgp_peerings</span> <span class="o">=</span> <span class="n">nb_bgp_peerings</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">hosts</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;bgp_peerings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_bgp_peerings</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_nornir_hosts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_nornir_hosts</span><span class="p">(</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_nornir_hosts" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieves a list of unique Nornir hosts from Nornir service based on provided filter criteria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of keyword arguments, where keys starting with 'F' are used as filters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout value (in seconds) for the job execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sorted list of unique Nornir host names that match the filter criteria.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Only filters with keys starting with 'F' are considered.</li>
<li>Hosts are collected from all workers where the job did not fail.</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_nornir_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a list of unique Nornir hosts from Nornir service based on provided filter criteria.</span>

<span class="sd">    Args:</span>
<span class="sd">        kwargs (dict): Dictionary of keyword arguments, where keys starting with &#39;F&#39; are used as filters.</span>
<span class="sd">        timeout (int): Timeout value (in seconds) for the job execution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Sorted list of unique Nornir host names that match the filter criteria.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Only filters with keys starting with &#39;F&#39; are considered.</span>
<span class="sd">        - Hosts are collected from all workers where the job did not fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">nornir_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span>
            <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;get_nornir_hosts&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">workers</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nornir_hosts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.sync_device_facts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sync_device_facts</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nornir&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_facts" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Updates device facts in NetBox, this task updates this device attributes:</p>
<ul>
<li>serial number</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The NetBox instance to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, no changes will be made to NetBox.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datasource</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data source to use. Supported datasources:</p>
<ul>
<li><strong>nornir</strong> - uses Nornir Service parse task to retrieve devices' data
    using NAPALM <code>get_facts</code> getter</li>
</ul>
              </div>
            </td>
            <td>
                  <code>&#39;nornir&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout for the job execution. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of devices to update.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of devices to process in each batch.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name to use, need to have branching plugin installed,
automatically creates branch if it does not exist in Netbox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the datasource job.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the results of the update operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a device does not exist in NetBox.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="UnsupportedServiceError (norfab.core.exceptions.UnsupportedServiceError)" href="../../../api_reference_core_norfab_exceptions/#norfab.core.exceptions.UnsupportedServiceError">UnsupportedServiceError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified datasource is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sync_device_facts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates device facts in NetBox, this task updates this device attributes:</span>

<span class="sd">    - serial number</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        instance (str, optional): The NetBox instance to use.</span>
<span class="sd">        dry_run (bool, optional): If True, no changes will be made to NetBox.</span>
<span class="sd">        datasource (str, optional): The data source to use. Supported datasources:</span>

<span class="sd">            - **nornir** - uses Nornir Service parse task to retrieve devices&#39; data</span>
<span class="sd">                using NAPALM `get_facts` getter</span>

<span class="sd">        timeout (int, optional): The timeout for the job execution. Defaults to 60.</span>
<span class="sd">        devices (list, optional): The list of devices to update.</span>
<span class="sd">        batch_size (int, optional): The number of devices to process in each batch.</span>
<span class="sd">        branch (str, optional): Branch name to use, need to have branching plugin installed,</span>
<span class="sd">            automatically creates branch if it does not exist in Netbox.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the datasource job.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the results of the update operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If a device does not exist in NetBox.</span>
<span class="sd">        UnsupportedServiceError: If the specified datasource is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:sync_device_facts&quot;</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
        <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="n">diff</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;add_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">datasource</span> <span class="o">==</span> <span class="s2">&quot;nornir&quot;</span><span class="p">:</span>
        <span class="c1"># source hosts list from Nornir</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_nornir_hosts</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syncing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s2"> devices&quot;</span><span class="p">)</span>
        <span class="c1"># fetch devices data from Netbox</span>
        <span class="n">nb_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">devices</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span>
            <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="c1"># remove devices that does not exist in Netbox</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nb_devices</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&#39; device does not exist in Netbox&quot;</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># iterate over devices in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;FL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;getters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;get_facts&quot;</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;retrieving facts for devices </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;FL&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span>
                <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parse&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Collect devices to update in bulk</span>
            <span class="n">devices_to_update</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2"> get_facts failed, errors: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">host_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">host_data</span><span class="p">[</span><span class="s2">&quot;napalm_get&quot;</span><span class="p">][</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> facts update failed: &#39;</span><span class="si">{</span><span class="n">host_data</span><span class="p">[</span><span class="s1">&#39;napalm_get&#39;</span><span class="p">][</span><span class="s1">&#39;exception&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb_devices</span><span class="p">[</span><span class="n">host</span><span class="p">]</span>

                    <span class="n">facts</span> <span class="o">=</span> <span class="n">host_data</span><span class="p">[</span><span class="s2">&quot;napalm_get&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;get_facts&quot;</span><span class="p">]</span>
                    <span class="n">desired_state</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;serial&quot;</span><span class="p">:</span> <span class="n">facts</span><span class="p">[</span><span class="s2">&quot;serial_number&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;serial&quot;</span><span class="p">:</span> <span class="n">nb_device</span><span class="p">[</span><span class="s2">&quot;serial&quot;</span><span class="p">],</span>
                    <span class="p">}</span>

                    <span class="c1"># Compare and get fields that need updating</span>
                    <span class="n">updates</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">compare_netbox_object_state</span><span class="p">(</span>
                        <span class="n">desired_state</span><span class="o">=</span><span class="n">desired_state</span><span class="p">,</span>
                        <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Only update if there are changes</span>
                    <span class="k">if</span> <span class="n">updates</span><span class="p">:</span>
                        <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_device</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                        <span class="n">devices_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">diff</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>

                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;sync_device_facts_dry_run&quot;</span>
                            <span class="k">if</span> <span class="n">dry_run</span>
                            <span class="k">else</span> <span class="s2">&quot;sync_device_facts&quot;</span>
                        <span class="p">):</span> <span class="p">(</span><span class="n">updates</span> <span class="k">if</span> <span class="n">updates</span> <span class="k">else</span> <span class="s2">&quot;Device facts in sync&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>

            <span class="c1"># Perform bulk update</span>
            <span class="k">if</span> <span class="n">devices_to_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">devices_to_update</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bulk update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedServiceError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">datasource</span><span class="si">}</span><span class="s2">&#39; datasource service not supported&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.sync_device_interfaces" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sync_device_interfaces</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nornir&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_interfaces" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Update or create device interfaces in Netbox using devices interfaces
data sourced via Nornir service <code>parse</code> task using NAPALM getter.</p>
<p>Interface parameters updated:</p>
<ul>
<li>interface name</li>
<li>interface description</li>
<li>mtu</li>
<li>mac address</li>
<li>admin status</li>
<li>speed</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Netbox instance name to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, no changes will be made to Netbox.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datasource</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data source to use. Supported datasources:</p>
<ul>
<li><strong>nornir</strong> - uses Nornir Service parse task to retrieve devices' data
    using NAPALM get_interfaces getter</li>
</ul>
              </div>
            </td>
            <td>
                  <code>&#39;nornir&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout for the job.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of devices to update.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, new interfaces will be created if they do not exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of devices to process in each batch.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name to use, need to have branching plugin installed,
automatically creates branch if it does not exist in Netbox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the datasource job.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the results of the update operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a device does not exist in Netbox.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="UnsupportedServiceError (norfab.core.exceptions.UnsupportedServiceError)" href="../../../api_reference_core_norfab_exceptions/#norfab.core.exceptions.UnsupportedServiceError">UnsupportedServiceError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified datasource is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sync_device_interfaces</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update or create device interfaces in Netbox using devices interfaces</span>
<span class="sd">    data sourced via Nornir service `parse` task using NAPALM getter.</span>

<span class="sd">    Interface parameters updated:</span>

<span class="sd">    - interface name</span>
<span class="sd">    - interface description</span>
<span class="sd">    - mtu</span>
<span class="sd">    - mac address</span>
<span class="sd">    - admin status</span>
<span class="sd">    - speed</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata.</span>
<span class="sd">        instance (str, optional): The Netbox instance name to use.</span>
<span class="sd">        dry_run (bool, optional): If True, no changes will be made to Netbox.</span>
<span class="sd">        datasource (str, optional): The data source to use. Supported datasources:</span>

<span class="sd">            - **nornir** - uses Nornir Service parse task to retrieve devices&#39; data</span>
<span class="sd">                using NAPALM get_interfaces getter</span>

<span class="sd">        timeout (int, optional): The timeout for the job.</span>
<span class="sd">        devices (list, optional): List of devices to update.</span>
<span class="sd">        create (bool, optional): If True, new interfaces will be created if they do not exist.</span>
<span class="sd">        batch_size (int, optional): The number of devices to process in each batch.</span>
<span class="sd">        branch (str, optional): Branch name to use, need to have branching plugin installed,</span>
<span class="sd">            automatically creates branch if it does not exist in Netbox.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the datasource job.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the results of the update operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If a device does not exist in Netbox.</span>
<span class="sd">        UnsupportedServiceError: If the specified datasource is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:sync_device_interfaces&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
        <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="n">diff</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;add_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">datasource</span> <span class="o">==</span> <span class="s2">&quot;nornir&quot;</span><span class="p">:</span>
        <span class="c1"># source hosts list from Nornir</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_nornir_hosts</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syncing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s2"> devices&quot;</span><span class="p">)</span>

        <span class="c1"># fetch devices interfaces data from Netbox</span>
        <span class="n">nb_interfaces_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_interfaces</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">devices</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span>
            <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="c1"># fetch devices data from Netbox</span>
        <span class="n">nb_devices_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">devices</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="c1"># iterate over devices in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;FL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;getters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;get_interfaces&quot;</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;retrieving interfaces for devices </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;FL&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span>
                <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parse&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Collect interfaces to update and create in bulk</span>
            <span class="n">interfaces_to_update</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">interfaces_to_create</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mac_addresses_to_create</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2"> get_interfaces failed, errors: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">host_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">host_data</span><span class="p">[</span><span class="s2">&quot;napalm_get&quot;</span><span class="p">][</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> interfaces update failed: &#39;</span><span class="si">{</span><span class="n">host_data</span><span class="p">[</span><span class="s1">&#39;napalm_get&#39;</span><span class="p">][</span><span class="s1">&#39;exception&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">nb_interfaces</span> <span class="o">=</span> <span class="n">nb_interfaces_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_interfaces</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&#39; has no interfaces in Netbox, skipping&quot;</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get device ID for creating new interfaces</span>
                    <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb_devices_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_device</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&#39; does not exist in Netbox&quot;</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">host_data</span><span class="p">[</span><span class="s2">&quot;napalm_get&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;get_interfaces&quot;</span><span class="p">]</span>

                    <span class="n">sync_key</span> <span class="o">=</span> <span class="s2">&quot;sync_device_interfaces&quot;</span>
                    <span class="n">create_key</span> <span class="o">=</span> <span class="s2">&quot;created_device_interfaces&quot;</span>
                    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                        <span class="n">sync_key</span> <span class="o">=</span> <span class="s2">&quot;sync_device_interfaces_dry_run&quot;</span>
                        <span class="n">create_key</span> <span class="o">=</span> <span class="s2">&quot;created_device_interfaces_dry_run&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">sync_key</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="n">create_key</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>

                    <span class="c1"># Process network device interfaces</span>
                    <span class="k">for</span> <span class="n">intf_name</span><span class="p">,</span> <span class="n">interface_data</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">intf_name</span> <span class="ow">in</span> <span class="n">nb_interfaces</span><span class="p">:</span>
                            <span class="c1"># Interface exists - prepare update</span>
                            <span class="n">nb_intf</span> <span class="o">=</span> <span class="n">nb_interfaces</span><span class="p">[</span><span class="n">intf_name</span><span class="p">]</span>

                            <span class="c1"># Build desired state</span>
                            <span class="n">desired_state</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">),</span>
                                <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="mi">10000</span> <span class="o">&gt;</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mtu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">desired_state</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_data</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">desired_state</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">interface_data</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
                                <span class="p">)</span>

                            <span class="c1"># Build current state</span>
                            <span class="n">current_state</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">nb_intf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">nb_intf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="n">nb_intf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mtu&quot;</span><span class="p">):</span>
                                <span class="n">current_state</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_intf</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">nb_intf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">):</span>
                                <span class="n">current_state</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_intf</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span>

                            <span class="c1"># Compare and get fields that need updating</span>
                            <span class="n">updates</span><span class="p">,</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">compare_netbox_object_state</span><span class="p">(</span>
                                <span class="n">desired_state</span><span class="o">=</span><span class="n">desired_state</span><span class="p">,</span>
                                <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                            <span class="p">)</span>

                            <span class="c1"># Only update if there are changes</span>
                            <span class="k">if</span> <span class="n">updates</span><span class="p">:</span>
                                <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_intf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                                <span class="n">interfaces_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
                                <span class="n">ret</span><span class="o">.</span><span class="n">diff</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">{})[</span><span class="n">intf_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>

                            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">sync_key</span><span class="p">][</span><span class="n">intf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">updates</span> <span class="k">if</span> <span class="n">updates</span> <span class="k">else</span> <span class="s2">&quot;Interface in sync&quot;</span>
                            <span class="p">)</span>

                            <span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mac_address&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">mac_address</span> <span class="ow">and</span> <span class="n">mac_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
                                <span class="c1"># Check if MAC already exists</span>
                                <span class="k">for</span> <span class="n">nb_mac</span> <span class="ow">in</span> <span class="n">nb_intf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mac_addresses&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                                    <span class="k">if</span> <span class="p">(</span>
                                        <span class="n">nb_mac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mac_address&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                        <span class="o">==</span> <span class="n">mac_address</span>
                                    <span class="p">):</span>
                                        <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Prepare MAC address for creation</span>
                                    <span class="n">mac_addresses_to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="p">{</span>
                                            <span class="s2">&quot;mac_address&quot;</span><span class="p">:</span> <span class="n">mac_address</span><span class="p">,</span>
                                            <span class="s2">&quot;assigned_object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;dcim.interface&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;assigned_object_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                                                <span class="n">nb_intf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                                            <span class="p">),</span>
                                        <span class="p">}</span>
                                    <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">create</span><span class="p">:</span>
                            <span class="c1"># Interface doesn&#39;t exist - prepare creation</span>
                            <span class="n">new_intf</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">intf_name</span><span class="p">,</span>
                                <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_device</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">),</span>
                                <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_enabled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="mi">10000</span> <span class="o">&gt;</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mtu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">new_intf</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_data</span><span class="p">[</span><span class="s2">&quot;mtu&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">new_intf</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_data</span><span class="p">[</span><span class="s2">&quot;speed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>

                            <span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">interface_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mac_address&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">mac_address</span> <span class="ow">and</span> <span class="n">mac_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]:</span>
                                <span class="n">mac_addresses_to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;mac_address&quot;</span><span class="p">:</span> <span class="n">mac_address</span><span class="p">,</span>
                                        <span class="s2">&quot;assigned_object_type&quot;</span><span class="p">:</span> <span class="s2">&quot;dcim.interface&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;assigned_object_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_intf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>

                            <span class="n">interfaces_to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_intf</span><span class="p">)</span>
                            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">create_key</span><span class="p">][</span><span class="n">intf_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_intf</span>

            <span class="c1"># Perform bulk updates and creations</span>
            <span class="k">if</span> <span class="n">interfaces_to_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">interfaces_to_update</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Bulk updated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interfaces_to_update</span><span class="p">)</span><span class="si">}</span><span class="s2"> interfaces&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bulk interface update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">interfaces_to_create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">interfaces_to_create</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Bulk created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interfaces_to_create</span><span class="p">)</span><span class="si">}</span><span class="s2"> interfaces&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bulk interface creation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Bulk create MAC addresses</span>
            <span class="k">if</span> <span class="n">mac_addresses_to_create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">mac_addresses</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">mac_addresses_to_create</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Bulk created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mac_addresses_to_create</span><span class="p">)</span><span class="si">}</span><span class="s2"> MAC addresses&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bulk MAC address creation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedServiceError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">datasource</span><span class="si">}</span><span class="s2">&#39; datasource service not supported&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.update_interfaces_description" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_interfaces_description</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">description_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.update_interfaces_description" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Updates the description of interfaces for specified devices in NetBox.</p>
<p>This method retrieves interface connections for the given devices, renders
new descriptions using a Jinja2 template, and updates the interface descriptions
in NetBox accordingly.</p>
<p>Only interfaces, console ports and console server ports supported.</p>
<p>Jinja2 environment receives these context variables for description template rendering:</p>
<ul>
<li>device - pynetbox <code>dcim.device</code> object</li>
<li>interface - pynetbox object - <code>dcim/interface</code>, <code>dcip.consoleport</code>,
    <code>dcim.consoleserverport</code> - depending on what kind of interface is that.</li>
<li>remote_device - string</li>
<li>remote_interface - string</li>
<li>termination_type - string</li>
<li>cable - dictionary of directly attached cable attributes:<ul>
<li>type</li>
<li>status</li>
<li>tenant - dictionary of <code>{name: tenant_name}</code></li>
<li>label</li>
<li>tags - list of <code>{name: tag_name}</code> dictionaries</li>
<li>custom_fields - dictionary with custom fields data</li>
<li>peer_termination_type</li>
<li>peer_device</li>
<li>peer_interface</li>
</ul>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The job context for logging and event handling.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of device names to update interfaces for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Jinja2 template string for the interface description.
Can reference remote template using <code>nf://path/to/template.txt</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>descriptions</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary keyed by interface names with values being interface
description strings</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interfaces</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specific interfaces to update.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface_regex</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Regex pattern to filter interfaces.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox instance identifier.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, performs a dry run without saving changes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for NetBox API requests.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name for NetBox instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Result</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An object containing the outcome of the update operation, including
before and after descriptions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_interfaces_description</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">description_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">descriptions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interfaces</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interface_regex</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the description of interfaces for specified devices in NetBox.</span>

<span class="sd">    This method retrieves interface connections for the given devices, renders</span>
<span class="sd">    new descriptions using a Jinja2 template, and updates the interface descriptions</span>
<span class="sd">    in NetBox accordingly.</span>

<span class="sd">    Only interfaces, console ports and console server ports supported.</span>

<span class="sd">    Jinja2 environment receives these context variables for description template rendering:</span>

<span class="sd">    - device - pynetbox `dcim.device` object</span>
<span class="sd">    - interface - pynetbox object - `dcim/interface`, `dcip.consoleport`,</span>
<span class="sd">        `dcim.consoleserverport` - depending on what kind of interface is that.</span>
<span class="sd">    - remote_device - string</span>
<span class="sd">    - remote_interface - string</span>
<span class="sd">    - termination_type - string</span>
<span class="sd">    - cable - dictionary of directly attached cable attributes:</span>
<span class="sd">        - type</span>
<span class="sd">        - status</span>
<span class="sd">        - tenant - dictionary of `{name: tenant_name}`</span>
<span class="sd">        - label</span>
<span class="sd">        - tags - list of `{name: tag_name}` dictionaries</span>
<span class="sd">        - custom_fields - dictionary with custom fields data</span>
<span class="sd">        - peer_termination_type</span>
<span class="sd">        - peer_device</span>
<span class="sd">        - peer_interface</span>

<span class="sd">    Args:</span>
<span class="sd">        job (Job): The job context for logging and event handling.</span>
<span class="sd">        devices (list): List of device names to update interfaces for.</span>
<span class="sd">        description_template (str): Jinja2 template string for the interface description.</span>
<span class="sd">            Can reference remote template using `nf://path/to/template.txt`.</span>
<span class="sd">        descriptions (dict): Dictionary keyed by interface names with values being interface</span>
<span class="sd">            description strings</span>
<span class="sd">        interfaces (Union[None, list], optional): Specific interfaces to update.</span>
<span class="sd">        interface_regex (Union[None, str], optional): Regex pattern to filter interfaces.</span>
<span class="sd">        instance (Union[None, str], optional): NetBox instance identifier.</span>
<span class="sd">        dry_run (bool, optional): If True, performs a dry run without saving changes.</span>
<span class="sd">        timeout (int, optional): Timeout for NetBox API requests.</span>
<span class="sd">        branch (str, optional): Branch name for NetBox instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Result: An object containing the outcome of the update operation, including</span>
<span class="sd">            before and after descriptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:update_interfaces_description&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">description_template</span><span class="p">:</span>
        <span class="c1"># get list of all interfaces connections</span>
        <span class="n">nb_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span>
            <span class="n">interface_regex</span><span class="o">=</span><span class="n">interface_regex</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">include_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># produce interfaces description and update it</span>
        <span class="k">while</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">device</span><span class="p">,</span> <span class="n">device_connections</span> <span class="o">=</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">interface</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">device_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">interface</span><span class="si">}</span><span class="s2"> updating description&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;termination_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;consoleport&quot;</span><span class="p">:</span>
                    <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">console_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;termination_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;consoleserverport&quot;</span><span class="p">:</span>
                    <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">console_server_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;termination_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;powerport&quot;</span><span class="p">:</span>
                    <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">power_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;termination_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;poweroutlet&quot;</span><span class="p">:</span>
                    <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">power_outlets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span>
                    <span class="p">)</span>
                <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="n">rendered_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja2_render_templates</span><span class="p">(</span>
                    <span class="n">templates</span><span class="o">=</span><span class="p">[</span><span class="n">description_template</span><span class="p">],</span>
                    <span class="n">context</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">nb_device</span><span class="p">,</span>
                        <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">nb_interface</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">connection</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="n">rendered_description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rendered_description</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">interface</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_interface</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
                    <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">rendered_description</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">nb_interface</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">rendered_description</span>
                <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">nb_interface</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">descriptions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">interface</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nb_interface</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">interface</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_interface</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
                        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">nb_interface</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
                    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">nb_interface</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.sync_device_ip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sync_device_ip</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nornir&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.sync_device_ip" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Update the IP addresses of devices in Netbox.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Netbox instance name to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, no changes will be made.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datasource</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data source to use. Supported datasources:</p>
<ul>
<li><strong>nornir</strong> - uses Nornir Service parse task to retrieve devices' data
    using NAPALM get_interfaces_ip getter</li>
</ul>
              </div>
            </td>
            <td>
                  <code>&#39;nornir&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The timeout for the operation.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of devices to update.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, new IP addresses will be created if they do not exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of devices to process in each batch.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name to use, need to have branching plugin installed,
automatically creates branch if it does not exist in Netbox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the results of the update operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a device does not exist in Netbox.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="UnsupportedServiceError (norfab.core.exceptions.UnsupportedServiceError)" href="../../../api_reference_core_norfab_exceptions/#norfab.core.exceptions.UnsupportedServiceError">UnsupportedServiceError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified datasource is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sync_device_ip</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">datasource</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the IP addresses of devices in Netbox.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        instance (str, optional): The Netbox instance name to use.</span>
<span class="sd">        dry_run (bool, optional): If True, no changes will be made.</span>
<span class="sd">        datasource (str, optional): The data source to use. Supported datasources:</span>

<span class="sd">            - **nornir** - uses Nornir Service parse task to retrieve devices&#39; data</span>
<span class="sd">                using NAPALM get_interfaces_ip getter</span>

<span class="sd">        timeout (int, optional): The timeout for the operation.</span>
<span class="sd">        devices (list, optional): The list of devices to update.</span>
<span class="sd">        create (bool, optional): If True, new IP addresses will be created if they do not exist.</span>
<span class="sd">        batch_size (int, optional): The number of devices to process in each batch.</span>
<span class="sd">        branch (str, optional): Branch name to use, need to have branching plugin installed,</span>
<span class="sd">            automatically creates branch if it does not exist in Netbox.</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the results of the update operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If a device does not exist in Netbox.</span>
<span class="sd">        UnsupportedServiceError: If the specified datasource is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:sync_device_ip&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">datasource</span> <span class="o">==</span> <span class="s2">&quot;nornir&quot;</span><span class="p">:</span>
        <span class="c1"># source hosts list from Nornir</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">devices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_nornir_hosts</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
        <span class="c1"># iterate over devices in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;FL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;getters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;get_interfaces_ip&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span>
                <span class="s2">&quot;nornir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parse&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">workers</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2"> get_interfaces_ip failed, errors: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">host_data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">updated</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;sync_ip_dry_run&quot;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s2">&quot;sync_ip&quot;</span><span class="p">:</span> <span class="n">updated</span><span class="p">,</span>
                        <span class="s2">&quot;created_ip_dry_run&quot;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s2">&quot;created_ip&quot;</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
                    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">host_data</span><span class="p">[</span><span class="s2">&quot;napalm_get&quot;</span><span class="p">][</span><span class="s2">&quot;get_interfaces_ip&quot;</span><span class="p">]</span>
                    <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">host</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_device</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&#39; does not exist in Netbox&quot;</span><span class="p">)</span>
                    <span class="n">nb_interfaces</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">device_id</span><span class="o">=</span><span class="n">nb_device</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span>
                    <span class="c1"># update interface IP addresses</span>
                    <span class="k">for</span> <span class="n">nb_interface</span> <span class="ow">in</span> <span class="n">nb_interfaces</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">interface</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="c1"># merge v6 into v4 addresses to save code repetition</span>
                        <span class="n">ips</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="o">**</span><span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ipv4&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                            <span class="o">**</span><span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ipv6&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="p">}</span>
                        <span class="c1"># update/create IP addresses</span>
                        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ip_data</span> <span class="ow">in</span> <span class="n">ips</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">ip_data</span><span class="p">[</span><span class="s2">&quot;prefix_length&quot;</span><span class="p">]</span>
                            <span class="c1"># get IP address info from Netbox</span>
                            <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                <span class="n">address</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> got multiple </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2"> IP addresses from Netbox, &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;NorFab Netbox Service only supports handling of non-duplicate IPs.&quot;</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="c1"># decide what to do</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_ip</span> <span class="ow">and</span> <span class="n">create</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="n">nb_ip</span> <span class="ow">and</span> <span class="n">create</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                                            <span class="n">address</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> failed to create </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2">, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                                        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_type</span> <span class="o">=</span> <span class="s2">&quot;dcim.interface&quot;</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_id</span> <span class="o">=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">id</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                <span class="n">created</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span>
                                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> created IP address </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> interface&quot;</span><span class="p">,</span>
                                    <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">nb_ip</span><span class="p">:</span>
                                <span class="n">nb_ip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_type</span> <span class="o">=</span> <span class="s2">&quot;dcim.interface&quot;</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_id</span> <span class="o">=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">id</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
                                    <span class="n">nb_ip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                <span class="n">updated</span><span class="p">[</span><span class="n">nb_ip</span><span class="o">.</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span>
                                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> updated IP address </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix_length</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">nb_interface</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> interface&quot;</span><span class="p">,</span>
                                    <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                                <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedServiceError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">datasource</span><span class="si">}</span><span class="s2">&#39; datasource service not supported&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.create_ip" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_ip</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vrf</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dns_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tenant</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_primary</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">create_peer_ip</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.create_ip" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Allocate the next available IP address from a given subnet.</p>
<p>This task finds or creates an IP address in NetBox, updates its metadata,
optionally links it to a device/interface, and supports a dry run mode for
previewing changes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prefix from which to allocate the IP address, could be:</p>
<ul>
<li>IPv4 prefix string e.g. 10.0.0.0/24</li>
<li>IPv6 prefix string e.g. 2001::/64</li>
<li>Prefix description string to filter by</li>
<li>Dictionary with prefix filters to feed <code>pynetbox</code> get method
    e.g. <code>{"prefix": "10.0.0.0/24", "site__name": "foo"}</code></li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A description for the allocated IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device associated with the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interface associated with the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vrf</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The VRF (Virtual Routing and Forwarding) instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tags</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of tags to associate with the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dns_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DNS name for the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tenant</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tenant associated with the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comments</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional comments for the IP address.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The NetBox instance to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, do not actually allocate the IP address.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name to use, need to have branching plugin
installed, automatically creates branch if it does not exist in Netbox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>mask length to use for IP address on creation or to
update existing IP address. On new IP address creation will create child
subnet of <code>mask_len</code> within parent <code>prefix</code>, new subnet not created for
existing IP addresses. <code>mask_len</code> argument ignored on dry run and ip allocated
from parent prefix directly.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_peer_ip</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True creates IP address for link peer -
remote device interface connected to requested device and interface</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the result of the IP allocation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Tasks execution follow these steps:</p>
<ol>
<li>
<p>Tries to find an existing IP in NetBox matching the device/interface/description.
    If found, uses it; otherwise, proceeds to create a new IP.</p>
</li>
<li>
<p>If prefix is a string, determines if its an IP network or a description.
    Builds a filter dictionary for NetBox queries, optionally including VRF.</p>
</li>
<li>
<p>Queries NetBox for the prefix using the constructed filter.</p>
</li>
<li>
<p>If dry_run is True, fetches the next available IP but doesnt create it.</p>
</li>
<li>
<p>If not a dry run, creates the next available IP in the prefix.</p>
</li>
<li>
<p>Updates IP attributes (description, VRF, tenant, DNS name, comments, role, tags)
    if provided and different from current values. Handles interface assignment and
    can set the IP as primary for the device.</p>
</li>
<li>
<p>If changes were made and not a dry run, saves the IP and device updates to NetBox.</p>
</li>
</ol>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_ip</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vrf</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dns_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tenant</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">comments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_primary</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_len</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">create_peer_ip</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allocate the next available IP address from a given subnet.</span>

<span class="sd">    This task finds or creates an IP address in NetBox, updates its metadata,</span>
<span class="sd">    optionally links it to a device/interface, and supports a dry run mode for</span>
<span class="sd">    previewing changes.</span>

<span class="sd">    Args:</span>
<span class="sd">        prefix (str): The prefix from which to allocate the IP address, could be:</span>

<span class="sd">            - IPv4 prefix string e.g. 10.0.0.0/24</span>
<span class="sd">            - IPv6 prefix string e.g. 2001::/64</span>
<span class="sd">            - Prefix description string to filter by</span>
<span class="sd">            - Dictionary with prefix filters to feed `pynetbox` get method</span>
<span class="sd">                e.g. `{&quot;prefix&quot;: &quot;10.0.0.0/24&quot;, &quot;site__name&quot;: &quot;foo&quot;}`</span>

<span class="sd">        description (str, optional): A description for the allocated IP address.</span>
<span class="sd">        device (str, optional): The device associated with the IP address.</span>
<span class="sd">        interface (str, optional): The interface associated with the IP address.</span>
<span class="sd">        vrf (str, optional): The VRF (Virtual Routing and Forwarding) instance.</span>
<span class="sd">        tags (list, optional): A list of tags to associate with the IP address.</span>
<span class="sd">        dns_name (str, optional): The DNS name for the IP address.</span>
<span class="sd">        tenant (str, optional): The tenant associated with the IP address.</span>
<span class="sd">        comments (str, optional): Additional comments for the IP address.</span>
<span class="sd">        instance (str, optional): The NetBox instance to use.</span>
<span class="sd">        dry_run (bool, optional): If True, do not actually allocate the IP address.</span>
<span class="sd">        branch (str, optional): Branch name to use, need to have branching plugin</span>
<span class="sd">            installed, automatically creates branch if it does not exist in Netbox.</span>
<span class="sd">        mask_len (int, optional): mask length to use for IP address on creation or to</span>
<span class="sd">            update existing IP address. On new IP address creation will create child</span>
<span class="sd">            subnet of `mask_len` within parent `prefix`, new subnet not created for</span>
<span class="sd">            existing IP addresses. `mask_len` argument ignored on dry run and ip allocated</span>
<span class="sd">            from parent prefix directly.</span>
<span class="sd">        create_peer_ip (bool, optional): If True creates IP address for link peer -</span>
<span class="sd">            remote device interface connected to requested device and interface</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the result of the IP allocation.</span>

<span class="sd">    Tasks execution follow these steps:</span>

<span class="sd">    1. Tries to find an existing IP in NetBox matching the device/interface/description.</span>
<span class="sd">        If found, uses it; otherwise, proceeds to create a new IP.</span>

<span class="sd">    2. If prefix is a string, determines if its an IP network or a description.</span>
<span class="sd">        Builds a filter dictionary for NetBox queries, optionally including VRF.</span>

<span class="sd">    3. Queries NetBox for the prefix using the constructed filter.</span>

<span class="sd">    4. If dry_run is True, fetches the next available IP but doesnt create it.</span>

<span class="sd">    5. If not a dry run, creates the next available IP in the prefix.</span>

<span class="sd">    6. Updates IP attributes (description, VRF, tenant, DNS name, comments, role, tags)</span>
<span class="sd">        if provided and different from current values. Handles interface assignment and</span>
<span class="sd">        can set the IP as primary for the device.</span>

<span class="sd">    7. If changes were made and not a dry run, saves the IP and device updates to NetBox.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:create_ip&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="p">{},</span> <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">])</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nb_ip</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb_device</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">create_peer_ip_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="c1"># source parent prefix from Netbox</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># try converting prefix to network, if fails prefix is not an IP network</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">is_network</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">is_network</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">vrf</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;vrf__name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">vrf</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;vrf__name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">}</span>
    <span class="n">nb_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_prefix</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to source parent prefix from Netbox - </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">parent_prefix_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># try to source existing IP from netbox</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">interface</span> <span class="ow">and</span> <span class="n">description</span><span class="p">:</span>
        <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">interface</span><span class="p">:</span>
        <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">description</span><span class="p">:</span>
        <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># create new IP address</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_ip</span><span class="p">:</span>
        <span class="c1"># check if interface has link peer that has IP within parent prefix</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">interface</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span>
                <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                <span class="n">devices</span><span class="o">=</span><span class="p">[</span><span class="n">device</span><span class="p">],</span>
                <span class="n">interface_regex</span><span class="o">=</span><span class="n">interface</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                <span class="n">include_virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">]:</span>
                <span class="n">peer</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device</span><span class="p">][</span><span class="n">interface</span><span class="p">]</span>
                <span class="c1"># do not process breakout cables</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># try to source peer ip subnet</span>
                <span class="n">nb_peer_ip</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]:</span>
                    <span class="n">nb_peer_ip</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">ip_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">device</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">],</span>
                        <span class="n">interface</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">],</span>
                        <span class="n">parent</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="c1"># try to source peer ip subnet</span>
                <span class="n">nb_peer_prefix</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">nb_peer_ip</span><span class="p">:</span>
                    <span class="n">peer_ip</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_interface</span><span class="p">(</span><span class="n">nb_peer_ip</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                    <span class="n">nb_peer_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">peer_ip</span><span class="o">.</span><span class="n">network</span><span class="p">),</span>
                        <span class="n">vrf__name</span><span class="o">=</span><span class="n">vrf</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">create_peer_ip</span> <span class="ow">and</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]:</span>
                    <span class="n">create_peer_ip_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;vrf&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">,</span>
                        <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span>
                        <span class="s2">&quot;tenant&quot;</span><span class="p">:</span> <span class="n">tenant</span><span class="p">,</span>
                        <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;create_peer_ip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;instance&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="c1"># use peer subnet to create IP address</span>
                <span class="k">if</span> <span class="n">nb_peer_prefix</span><span class="p">:</span>
                    <span class="n">nb_prefix</span> <span class="o">=</span> <span class="n">nb_peer_prefix</span>
                    <span class="n">mask_len</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># cancel subnet creation</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Using link peer &#39;</span><span class="si">{</span><span class="n">peer</span><span class="p">[</span><span class="s1">&#39;remote_device&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">peer</span><span class="p">[</span><span class="s1">&#39;remote_interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;prefix &#39;</span><span class="si">{</span><span class="n">nb_peer_prefix</span><span class="si">}</span><span class="s2">&#39; to create IP address&quot;</span>
                    <span class="p">)</span>
        <span class="c1"># if mask_len provided create new subnet</span>
        <span class="k">if</span> <span class="n">mask_len</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span> <span class="ow">and</span> <span class="n">mask_len</span> <span class="o">!=</span> <span class="n">parent_prefix_len</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask_len</span> <span class="o">&lt;</span> <span class="n">parent_prefix_len</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mask length &#39;</span><span class="si">{</span><span class="n">mask_len</span><span class="si">}</span><span class="s2">&#39; must be longer then &#39;</span><span class="si">{</span><span class="n">parent_prefix_len</span><span class="si">}</span><span class="s2">&#39; prefix length&quot;</span>
                <span class="p">)</span>
            <span class="n">prefix_status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">if</span> <span class="n">prefix_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;reserved&quot;</span><span class="p">,</span> <span class="s2">&quot;deprecated&quot;</span><span class="p">]:</span>
                <span class="n">prefix_status</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">child_subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_prefix</span><span class="p">(</span>
                <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">),</span>
                <span class="n">prefixlen</span><span class="o">=</span><span class="n">mask_len</span><span class="p">,</span>
                <span class="n">vrf</span><span class="o">=</span><span class="n">vrf</span><span class="p">,</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
                <span class="n">tenant</span><span class="o">=</span><span class="n">tenant</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">prefix_status</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">child_subnet</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">vrf</span><span class="p">:</span>
                <span class="n">prefix</span><span class="p">[</span><span class="s2">&quot;vrf__name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrf</span>
            <span class="n">nb_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">prefix</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_prefix</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to source child prefix of mask length &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">mask_len</span><span class="si">}</span><span class="s2">&#39; from &#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39; parent prefix&quot;</span>
                <span class="p">)</span>
        <span class="c1"># execute dry run on new IP</span>
        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">available_ips</span><span class="o">.</span><span class="n">list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;vrf&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">,</span>
                <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
                <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># add branch to results</span>
            <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="c1"># create new IP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nb_ip</span> <span class="o">=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">available_ips</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Created &#39;</span><span class="si">{</span><span class="n">nb_ip</span><span class="si">}</span><span class="s2">&#39; IP address for &#39;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">interface</span><span class="si">}</span><span class="s2">&#39; within &#39;</span><span class="si">{</span><span class="n">nb_prefix</span><span class="si">}</span><span class="s2">&#39; prefix&quot;</span>
            <span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using existing IP address </span><span class="si">{</span><span class="n">nb_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span>

    <span class="c1"># update IP address parameters</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">description</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">vrf</span> <span class="ow">and</span> <span class="n">vrf</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">vrf</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">vrf</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">tenant</span> <span class="ow">and</span> <span class="n">tenant</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">tenant</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">tenant</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tenant</span><span class="p">}</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">dns_name</span> <span class="ow">and</span> <span class="n">dns_name</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">dns_name</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">dns_name</span> <span class="o">=</span> <span class="n">dns_name</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">comments</span> <span class="ow">and</span> <span class="n">comments</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">!=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">role</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">tags</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">nb_ip</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span>
                <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">and</span> <span class="n">interface</span><span class="p">:</span>
        <span class="n">nb_interface</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">interface</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_interface</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to source &#39;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">interface</span><span class="si">}</span><span class="s2">&#39; interface from Netbox&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">,</span> <span class="s2">&quot;assigned_object&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object</span> <span class="o">!=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">id</span>
        <span class="p">):</span>
            <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_id</span> <span class="o">=</span> <span class="n">nb_interface</span><span class="o">.</span><span class="n">id</span>
            <span class="n">nb_ip</span><span class="o">.</span><span class="n">assigned_object_type</span> <span class="o">=</span> <span class="s2">&quot;dcim.interface&quot;</span>
            <span class="k">if</span> <span class="n">is_primary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="n">nb_device</span><span class="o">.</span><span class="n">primary_ip4</span> <span class="o">=</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">id</span>
            <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">mask_len</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">mask_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask_len</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">has_changes</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># save IP address into Netbox</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">has_changes</span><span class="p">:</span>
        <span class="n">nb_ip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; IP address parameters&quot;</span><span class="p">)</span>
        <span class="c1"># make IP primary for device</span>
        <span class="k">if</span> <span class="n">is_primary</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">nb_device</span><span class="p">:</span>
            <span class="n">nb_device</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>

    <span class="c1"># form and return results</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
        <span class="s2">&quot;vrf&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_ip</span><span class="o">.</span><span class="n">vrf</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">vrf</span> <span class="k">else</span> <span class="n">nb_ip</span><span class="o">.</span><span class="n">vrf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
        <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># add branch to results</span>
    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>

    <span class="c1"># create IP address for peer</span>
    <span class="k">if</span> <span class="n">create_peer_ip</span> <span class="ow">and</span> <span class="n">create_peer_ip_data</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Creating IP address for link peer &#39;</span><span class="si">{</span><span class="n">create_peer_ip_data</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">create_peer_ip_data</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
        <span class="n">peer_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_ip</span><span class="p">(</span>
            <span class="o">**</span><span class="n">create_peer_ip_data</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="p">),</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">peer_ip</span><span class="o">.</span><span class="n">failed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;peer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_ip</span><span class="o">.</span><span class="n">result</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.create_prefix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_prefix</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prefixlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vrf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tenant</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">site</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.create_prefix" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Creates a new IP prefix in NetBox or updates an existing one.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parent</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parent prefix to allocate new prefix from, could be:</p>
<ul>
<li>IPv4 prefix string e.g. 10.0.0.0/24</li>
<li>IPv6 prefix string e.g. 2001::/64</li>
<li>Prefix description string to filter by</li>
<li>Dictionary with prefix filters for <code>pynetbox</code> prefixes.get method
    e.g. <code>{"prefix": "10.0.0.0/24", "site__name": "foo"}</code></li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Description for the new prefix, prefix description used for
deduplication to source existng prefixes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefixlen</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prefix length of the new prefix to create, by default
allocates next availabe /30 point-to-point prefix.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vrf</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the VRF to associate with the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tags</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of tags to assign to the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tenant</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the tenant to associate with the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comments</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Comments for the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>role</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Role to assign to the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>site</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the site to associate with the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Status of the prefix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox instance identifier.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, simulates the creation without making changes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Branch name to use, need to have branching plugin installed,
automatically creates branch if it does not exist in Netbox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Result</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An object containing the outcome, including status, details of the prefix, and resources used.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="n">CreatePrefixInput</span><span class="p">,</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()},</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_prefix</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prefixlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">vrf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tenant</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">comments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">site</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new IP prefix in NetBox or updates an existing one.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent (Union[str, dict]): Parent prefix to allocate new prefix from, could be:</span>

<span class="sd">            - IPv4 prefix string e.g. 10.0.0.0/24</span>
<span class="sd">            - IPv6 prefix string e.g. 2001::/64</span>
<span class="sd">            - Prefix description string to filter by</span>
<span class="sd">            - Dictionary with prefix filters for `pynetbox` prefixes.get method</span>
<span class="sd">                e.g. `{&quot;prefix&quot;: &quot;10.0.0.0/24&quot;, &quot;site__name&quot;: &quot;foo&quot;}`</span>

<span class="sd">        description (str): Description for the new prefix, prefix description used for</span>
<span class="sd">            deduplication to source existng prefixes.</span>
<span class="sd">        prefixlen (int, optional): The prefix length of the new prefix to create, by default</span>
<span class="sd">            allocates next availabe /30 point-to-point prefix.</span>
<span class="sd">        vrf (str, optional): Name of the VRF to associate with the prefix.</span>
<span class="sd">        tags (Union[None, list], optional): List of tags to assign to the prefix.</span>
<span class="sd">        tenant (str, optional): Name of the tenant to associate with the prefix.</span>
<span class="sd">        comments (str, optional): Comments for the prefix.</span>
<span class="sd">        role (str, optional): Role to assign to the prefix.</span>
<span class="sd">        site (str, optional): Name of the site to associate with the prefix.</span>
<span class="sd">        status (str, optional): Status of the prefix.</span>
<span class="sd">        instance (Union[None, str], optional): NetBox instance identifier.</span>
<span class="sd">        dry_run (bool, optional): If True, simulates the creation without making changes.</span>
<span class="sd">        branch (str, optional): Branch name to use, need to have branching plugin installed,</span>
<span class="sd">            automatically creates branch if it does not exist in Netbox.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Result: An object containing the outcome, including status, details of the prefix, and resources used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:create_prefix&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
        <span class="n">diff</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">nb_prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Processing prefix create request within &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; for &#39;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&#39; subnet&quot;</span>
    <span class="p">)</span>

    <span class="c1"># source parent prefix from Netbox</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># check if parent prefix is IP network or description</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">is_network</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">is_network</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">vrf</span><span class="p">:</span>
            <span class="n">parent_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;vrf__name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">parent_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">vrf</span><span class="p">:</span>
            <span class="n">parent_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;vrf__name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">is_network</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">parent_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">}</span>
    <span class="n">nb_parent_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">parent_filters</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_parent_prefix</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to source parent prefix from Netbox - </span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># check that parent vrf and new prefix vrf are same</span>
    <span class="k">if</span> <span class="n">vrf</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">vrf</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Parent prefix vrf &#39;</span><span class="si">{</span><span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="si">}</span><span class="s2">&#39; not same as requested child prefix vrf &#39;</span><span class="si">{</span><span class="n">vrf</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># try to source existing prefix from netbox</span>
    <span class="n">prefix_filters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">vrf</span><span class="p">:</span>
        <span class="n">prefix_filters</span><span class="p">[</span><span class="s2">&quot;vrf__name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vrf</span>
    <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
        <span class="n">prefix_filters</span><span class="p">[</span><span class="s2">&quot;site__name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
        <span class="n">prefix_filters</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prefix_filters</span><span class="p">:</span>
            <span class="n">nb_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">prefixes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">within</span><span class="o">=</span><span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">prefix_filters</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to source existing prefix from Netbox using filters &#39;</span><span class="si">{</span><span class="n">prefix_filters</span><span class="si">}</span><span class="s2">&#39;, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># create new prefix</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_prefix</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating new &#39;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&#39; prefix within &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; prefix&quot;</span><span class="p">)</span>
        <span class="c1"># execute dry run on new prefix</span>
        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">nb_prefixes</span> <span class="o">=</span> <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">available_prefixes</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_prefixes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parent prefix &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; has no child prefixes available&quot;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">pfx</span> <span class="ow">in</span> <span class="n">nb_prefixes</span><span class="p">:</span>
                <span class="c1"># parent prefix empty, can use first subnet as a child prefix</span>
                <span class="k">if</span> <span class="n">pfx</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
                    <span class="n">nb_prefix</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
                <span class="c1"># find child prefix by prefixlenght</span>
                <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">pfx</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">nb_prefix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pfx</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parent prefix &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; has no child prefixes available with &#39;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&#39; prefix length&quot;</span>
                <span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">nb_prefix</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                <span class="s2">&quot;vrf&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">,</span>
                <span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># add branch to results</span>
            <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="c1"># create new prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nb_prefix</span> <span class="o">=</span> <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">available_prefixes</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;prefix_length&quot;</span><span class="p">:</span> <span class="n">prefixlen</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed creating child prefix of &#39;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&#39; prefix length &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;within parent prefix &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">nb_parent_prefix</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new &#39;</span><span class="si">{</span><span class="n">nb_prefix</span><span class="si">}</span><span class="s2">&#39; prefix within &#39;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39; prefix&quot;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check existing prefix length matching requested length</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found existing child prefix &#39;</span><span class="si">{</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39; with mismatch &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;requested prefix length &#39;/</span><span class="si">{</span><span class="n">prefixlen</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using existing prefix </span><span class="si">{</span><span class="n">nb_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># update prefix parameters</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">description</span> <span class="o">!=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">description</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
    <span class="k">if</span> <span class="n">vrf</span> <span class="ow">and</span> <span class="n">vrf</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">):</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;vrf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">vrf</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">tenant</span> <span class="ow">and</span> <span class="n">tenant</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">tenant</span><span class="p">):</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;tenant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">tenant</span><span class="p">)</span> <span class="k">if</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">tenant</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">tenant</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">tenant</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tenant</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">site</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span> <span class="o">!=</span> <span class="n">site</span><span class="p">:</span>
        <span class="n">nb_site</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_site</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NetboxAllocationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get &#39;</span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&#39; site from Netbox&quot;</span><span class="p">)</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span> <span class="k">if</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">nb_site</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope_type</span> <span class="o">=</span> <span class="s2">&quot;dcim.site&quot;</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope_id</span> <span class="o">=</span> <span class="n">nb_site</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">status</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">status</span><span class="o">.</span><span class="n">title</span><span class="p">()}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">comments</span> <span class="ow">and</span> <span class="n">comments</span> <span class="o">!=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">comments</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">comments</span><span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>
    <span class="k">if</span> <span class="n">role</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">!=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">role</span><span class="p">:</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">role</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>
    <span class="n">existing_tags</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">existing_tags</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
        <span class="n">changed</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">existing_tags</span><span class="p">,</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_tags</span><span class="p">]</span> <span class="o">+</span> <span class="n">existing_tags</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_tags</span><span class="p">:</span>
                <span class="n">nb_prefix</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span>

    <span class="c1"># save prefix into Netbox</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">diff</span> <span class="o">=</span> <span class="n">changed</span>
    <span class="k">elif</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">diff</span> <span class="o">=</span> <span class="n">changed</span>
        <span class="n">nb_prefix</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;created&quot;</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;updated&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unchanged&quot;</span>

    <span class="c1"># source vrf name</span>
    <span class="n">vrf_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">vrf_name</span> <span class="o">=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vrf_name</span> <span class="o">=</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">vrf</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># form and return results</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;vrf&quot;</span><span class="p">:</span> <span class="n">vrf_name</span><span class="p">,</span>
        <span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span> <span class="k">if</span> <span class="n">nb_prefix</span><span class="o">.</span><span class="n">scope</span> <span class="k">else</span> <span class="n">site</span><span class="p">,</span>
        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">nb_parent_prefix</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># add branch to results</span>
    <span class="k">if</span> <span class="n">branch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_containerlab_inventory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_containerlab_inventory</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">lab_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tenant</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ipv4_subnet</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;172.100.100.0/24&#39;</span><span class="p">,</span> <span class="n">ports</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">),</span> <span class="n">ports_map</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_containerlab_inventory" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve and construct Containerlab inventory from NetBox data.</p>
<p>Containerlab node details must be defined under device configuration
context <code>norfab.containerlab</code> path, for example:</p>
<div class="highlight"><pre><span></span><code>{
    &quot;norfab&quot;: {
        &quot;containerlab&quot;: {
            &quot;kind&quot;: &quot;ceos&quot;,
            &quot;image&quot;: &quot;ceos:latest&quot;,
            &quot;mgmt-ipv4&quot;: &quot;172.100.100.10/24&quot;,
            &quot;ports&quot;: [
                {10000: 22},
                {10001: 830}
            ],

            ... any other node parameters ...

            &quot;interfaces_rename&quot;: [
                {
                    &quot;find&quot;: &quot;eth&quot;,
                    &quot;replace&quot;: &quot;Eth&quot;,
                    &quot;use_regex&quot;: false
                }
            ]
        }
    }
}
</code></pre></div>
<p>For complete list of parameters refer to
<a href="https://containerlab.dev/manual/nodes/">Containerlab nodes definition</a>.</p>
<p>Special handling given to these parameters:</p>
<ul>
<li><code>lab_name</code> - if not provided uses <code>tenant</code> argument value as a lab name</li>
<li><code>kind</code> - uses device platform field value by default</li>
<li><code>image</code> - uses <code>image</code> value if provided, otherwise uses <code>{kind}:latest</code></li>
<li><code>interfaces_rename</code> - a list of one or more interface renaming instructions,
    each item must have <code>find</code> and <code>replace</code> defined, optional <code>use_regex</code>
    flag specifies whether to use regex based pattern substitution.</li>
</ul>
<p>To retrieve topology data from Netbox at least one of these arguments must be provided
to identify a set of devices to include into Containerlab topology:</p>
<ul>
<li><code>tenant</code> - topology constructed using all devices and links that belong to this tenant</li>
<li><code>devices</code> - creates topology only using devices in the lists</li>
<li><code>filters</code> - list of device filters to retrieve from Netbox and add to topology</li>
</ul>
<p>If multiple of above arguments provided, resulting lab topology is a sum of all
devices matched.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lab_name</code>
            </td>
            <td>
                  <code>(<span title="str">str</span>, <span title="Mandatory">Mandatory</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of containerlab to construct inventory for.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tenant</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Construct topology using given tenant's devices</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filters</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of filters to apply when retrieving devices from NetBox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of specific devices to retrieve from NetBox.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox instance to use.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default containerlab image to use,</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ipv4_subnet</code>
            </td>
            <td>
                  <code>(<span title="str">str</span>, <span title="Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Management subnet to use to IP number nodes
starting with 2nd IP in the subnet, in assumption that 1st IP is a default gateway.</p>
              </div>
            </td>
            <td>
                  <code>&#39;172.100.100.0/24&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ports</code>
            </td>
            <td>
                  <code>(<span title="tuple">tuple</span>, <span title="Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ports range to use for nodes.</p>
              </div>
            </td>
            <td>
                  <code>(12000, 15000)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ports_map</code>
            </td>
            <td>
                  <code>(<span title="dict">dict</span>, <span title="Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary keyed by node name with list of ports maps to use,</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cache usage options:</p>
<ul>
<li>True: Use data stored in cache if it is up to date, refresh it otherwise.</li>
<li>False: Do not use cache and do not update cache.</li>
<li>"refresh": Ignore data in cache and replace it with data fetched from Netbox.</li>
<li>"force": Use data in cache without checking if it is up to date.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Containerlab inventory dictionary containing lab topology data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span>
<span class="normal">3587</span>
<span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span>
<span class="normal">3594</span>
<span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span>
<span class="normal">3687</span>
<span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span>
<span class="normal">3709</span>
<span class="normal">3710</span>
<span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span>
<span class="normal">3755</span>
<span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span>
<span class="normal">3761</span>
<span class="normal">3762</span>
<span class="normal">3763</span>
<span class="normal">3764</span>
<span class="normal">3765</span>
<span class="normal">3766</span>
<span class="normal">3767</span>
<span class="normal">3768</span>
<span class="normal">3769</span>
<span class="normal">3770</span>
<span class="normal">3771</span>
<span class="normal">3772</span>
<span class="normal">3773</span>
<span class="normal">3774</span>
<span class="normal">3775</span>
<span class="normal">3776</span>
<span class="normal">3777</span>
<span class="normal">3778</span>
<span class="normal">3779</span>
<span class="normal">3780</span>
<span class="normal">3781</span>
<span class="normal">3782</span>
<span class="normal">3783</span>
<span class="normal">3784</span>
<span class="normal">3785</span>
<span class="normal">3786</span>
<span class="normal">3787</span>
<span class="normal">3788</span>
<span class="normal">3789</span>
<span class="normal">3790</span>
<span class="normal">3791</span>
<span class="normal">3792</span>
<span class="normal">3793</span>
<span class="normal">3794</span>
<span class="normal">3795</span>
<span class="normal">3796</span>
<span class="normal">3797</span>
<span class="normal">3798</span>
<span class="normal">3799</span>
<span class="normal">3800</span>
<span class="normal">3801</span>
<span class="normal">3802</span>
<span class="normal">3803</span>
<span class="normal">3804</span>
<span class="normal">3805</span>
<span class="normal">3806</span>
<span class="normal">3807</span>
<span class="normal">3808</span>
<span class="normal">3809</span>
<span class="normal">3810</span>
<span class="normal">3811</span>
<span class="normal">3812</span>
<span class="normal">3813</span>
<span class="normal">3814</span>
<span class="normal">3815</span>
<span class="normal">3816</span>
<span class="normal">3817</span>
<span class="normal">3818</span>
<span class="normal">3819</span>
<span class="normal">3820</span>
<span class="normal">3821</span>
<span class="normal">3822</span>
<span class="normal">3823</span>
<span class="normal">3824</span>
<span class="normal">3825</span>
<span class="normal">3826</span>
<span class="normal">3827</span>
<span class="normal">3828</span>
<span class="normal">3829</span>
<span class="normal">3830</span>
<span class="normal">3831</span>
<span class="normal">3832</span>
<span class="normal">3833</span>
<span class="normal">3834</span>
<span class="normal">3835</span>
<span class="normal">3836</span>
<span class="normal">3837</span>
<span class="normal">3838</span>
<span class="normal">3839</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_containerlab_inventory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">lab_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tenant</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ipv4_subnet</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;172.100.100.0/24&quot;</span><span class="p">,</span>
    <span class="n">ports</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">),</span>
    <span class="n">ports_map</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve and construct Containerlab inventory from NetBox data.</span>

<span class="sd">    Containerlab node details must be defined under device configuration</span>
<span class="sd">    context `norfab.containerlab` path, for example:</span>

<span class="sd">    ```</span>
<span class="sd">    {</span>
<span class="sd">        &quot;norfab&quot;: {</span>
<span class="sd">            &quot;containerlab&quot;: {</span>
<span class="sd">                &quot;kind&quot;: &quot;ceos&quot;,</span>
<span class="sd">                &quot;image&quot;: &quot;ceos:latest&quot;,</span>
<span class="sd">                &quot;mgmt-ipv4&quot;: &quot;172.100.100.10/24&quot;,</span>
<span class="sd">                &quot;ports&quot;: [</span>
<span class="sd">                    {10000: 22},</span>
<span class="sd">                    {10001: 830}</span>
<span class="sd">                ],</span>

<span class="sd">                ... any other node parameters ...</span>

<span class="sd">                &quot;interfaces_rename&quot;: [</span>
<span class="sd">                    {</span>
<span class="sd">                        &quot;find&quot;: &quot;eth&quot;,</span>
<span class="sd">                        &quot;replace&quot;: &quot;Eth&quot;,</span>
<span class="sd">                        &quot;use_regex&quot;: false</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">    }</span>
<span class="sd">    ```</span>

<span class="sd">    For complete list of parameters refer to</span>
<span class="sd">    [Containerlab nodes definition](https://containerlab.dev/manual/nodes/).</span>

<span class="sd">    Special handling given to these parameters:</span>

<span class="sd">    - `lab_name` - if not provided uses `tenant` argument value as a lab name</span>
<span class="sd">    - `kind` - uses device platform field value by default</span>
<span class="sd">    - `image` - uses `image` value if provided, otherwise uses `{kind}:latest`</span>
<span class="sd">    - `interfaces_rename` - a list of one or more interface renaming instructions,</span>
<span class="sd">        each item must have `find` and `replace` defined, optional `use_regex`</span>
<span class="sd">        flag specifies whether to use regex based pattern substitution.</span>

<span class="sd">    To retrieve topology data from Netbox at least one of these arguments must be provided</span>
<span class="sd">    to identify a set of devices to include into Containerlab topology:</span>

<span class="sd">    - `tenant` - topology constructed using all devices and links that belong to this tenant</span>
<span class="sd">    - `devices` - creates topology only using devices in the lists</span>
<span class="sd">    - `filters` - list of device filters to retrieve from Netbox and add to topology</span>

<span class="sd">    If multiple of above arguments provided, resulting lab topology is a sum of all</span>
<span class="sd">    devices matched.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        lab_name (str, Mandatory): Name of containerlab to construct inventory for.</span>
<span class="sd">        tenant (str, optional): Construct topology using given tenant&#39;s devices</span>
<span class="sd">        filters (list, optional): List of filters to apply when retrieving devices from NetBox.</span>
<span class="sd">        devices (list, optional): List of specific devices to retrieve from NetBox.</span>
<span class="sd">        instance (str, optional): NetBox instance to use.</span>
<span class="sd">        image (str, optional): Default containerlab image to use,</span>
<span class="sd">        ipv4_subnet (str, Optional): Management subnet to use to IP number nodes</span>
<span class="sd">            starting with 2nd IP in the subnet, in assumption that 1st IP is a default gateway.</span>
<span class="sd">        ports (tuple, Optional): Ports range to use for nodes.</span>
<span class="sd">        ports_map (dict, Optional): dictionary keyed by node name with list of ports maps to use,</span>
<span class="sd">        cache (Union[bool, str], optional): Cache usage options:</span>

<span class="sd">            - True: Use data stored in cache if it is up to date, refresh it otherwise.</span>
<span class="sd">            - False: Do not use cache and do not update cache.</span>
<span class="sd">            - &quot;refresh&quot;: Ignore data in cache and replace it with data fetched from Netbox.</span>
<span class="sd">            - &quot;force&quot;: Use data in cache without checking if it is up to date.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Containerlab inventory dictionary containing lab topology data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">links</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">[]</span>
    <span class="n">ports_map</span> <span class="o">=</span> <span class="n">ports_map</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">endpts_done</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to deduplicate links</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="c1"># handle lab name and tenant name with filters</span>
    <span class="k">if</span> <span class="n">lab_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tenant</span><span class="p">:</span>
        <span class="n">lab_name</span> <span class="o">=</span> <span class="n">tenant</span>
    <span class="c1"># add tenant filters</span>
    <span class="k">if</span> <span class="n">tenant</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[{}]</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">filter</span><span class="p">[</span><span class="s2">&quot;tenant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">name: </span><span class="se">{{</span><span class="s1">exact: &quot;</span><span class="si">{</span><span class="n">tenant</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">}}}}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedNetboxVersion</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Netbox version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_version</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not supported, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;minimum required version is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compatible_ge_v4</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="c1"># construct inventory</span>
    <span class="n">inventory</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">lab_name</span><span class="p">,</span>
        <span class="s2">&quot;topology&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="n">links</span><span class="p">},</span>
        <span class="s2">&quot;mgmt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ipv4-subnet&quot;</span><span class="p">:</span> <span class="n">ipv4_subnet</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;br-</span><span class="si">{</span><span class="n">lab_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_containerlab_inventory&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="n">inventory</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">mgmt_net</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">ipv4_subnet</span><span class="p">)</span>
    <span class="n">available_ips</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mgmt_net</span><span class="o">.</span><span class="n">hosts</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># run checks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">available_ips</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Need IPs to allocate, but &#39;</span><span class="si">{</span><span class="n">ipv4_subnet</span><span class="si">}</span><span class="s2">&#39; given&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ports</span><span class="p">:</span>
        <span class="n">available_ports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Need ports to allocate, but &#39;</span><span class="si">{</span><span class="n">ports</span><span class="si">}</span><span class="s2">&#39; given&quot;</span><span class="p">)</span>

    <span class="c1"># check Netbox status</span>
    <span class="n">netbox_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_netbox_status</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">netbox_status</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">instance</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Netbox status is no good: </span><span class="si">{</span><span class="n">netbox_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="c1"># retrieve devices data</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Fetching devices from </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> Netbox instance, devices &#39;</span><span class="si">{</span><span class="n">devices</span><span class="si">}</span><span class="s2">&#39;, filters &#39;</span><span class="si">{</span><span class="n">filters</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;Fetching devices data from Netbox&quot;</span><span class="p">)</span>
    <span class="n">nb_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
        <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span>
        <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
        <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># form Containerlab nodes inventory</span>
    <span class="k">for</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">nb_devices</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;config_context&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;norfab&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;containerlab&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># populate node parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2"> - has no &#39;kind&#39; of &#39;platform&#39; defined, skipping&quot;</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:latest&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mgmt-ipv4&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">available_ips</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;mgmt-ipv4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">available_ips</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Run out of IP addresses to allocate&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ports&quot;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">[</span><span class="s2">&quot;ports&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># use ports map</span>
            <span class="k">if</span> <span class="n">ports_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device_name</span><span class="p">):</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;ports&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ports_map</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span>
            <span class="c1"># allocate next-available ports</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;22/tcp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;23/tcp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;80/tcp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;161/udp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;443/tcp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;830/tcp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;8080/tcp&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="n">available_ports</span><span class="p">:</span>
                        <span class="n">node</span><span class="p">[</span><span class="s2">&quot;ports&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">available_ports</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Run out of TCP / UDP ports to allocate.&quot;</span>
                        <span class="p">)</span>

        <span class="c1"># save node content</span>
        <span class="n">nodes</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node added </span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># return if no nodes found for provided parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - no devices found in Netbox&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - no devices found in Netbox, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;devices - &#39;</span><span class="si">{</span><span class="n">devices</span><span class="si">}</span><span class="s2">&#39;, filters - &#39;</span><span class="si">{</span><span class="n">filters</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;Fetching connections data from Netbox&quot;</span><span class="p">)</span>

    <span class="c1"># query interface connections data from netbox</span>
    <span class="n">nb_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span>
    <span class="p">)</span>
    <span class="c1"># save connections data to links inventory</span>
    <span class="k">while</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
        <span class="n">device</span><span class="p">,</span> <span class="n">device_connections</span> <span class="o">=</span> <span class="n">nb_connections</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">interface</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">device_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># skip non ethernet links</span>
            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;termination_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;interface&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># skip orphaned links</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># skip connections to devices that are not part of lab</span>
            <span class="k">if</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">endpoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">link</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;veth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="n">endpoints</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># add A node</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
                    <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># add B node</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;breakout&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">]</span>
            <span class="c1"># save the link</span>
            <span class="n">a_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">],</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">b_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">],</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">a_end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endpts_done</span> <span class="ow">and</span> <span class="n">b_end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endpts_done</span><span class="p">:</span>
                <span class="n">endpts_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_end</span><span class="p">)</span>
                <span class="n">endpts_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_end</span><span class="p">)</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Link added </span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="c1"># query circuits connections data from netbox</span>
    <span class="n">nb_circuits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_circuits</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span>
    <span class="p">)</span>
    <span class="c1"># save circuits data to hosts&#39; inventory</span>
    <span class="k">while</span> <span class="n">nb_circuits</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
        <span class="n">device</span><span class="p">,</span> <span class="n">device_circuits</span> <span class="o">=</span> <span class="n">nb_circuits</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">device_circuits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># skip circuits not connected to devices</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">circuit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># skip circuits to devices that are not part of lab</span>
            <span class="k">if</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">endpoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">link</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;veth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="n">endpoints</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># add A node</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">device</span><span class="p">,</span>
                    <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># add B node</span>
            <span class="n">endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;remote_device&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="n">circuit</span><span class="p">[</span><span class="s2">&quot;remote_interface&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># save the link</span>
            <span class="n">a_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">],</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">b_end</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;node&quot;</span><span class="p">],</span>
                <span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">a_end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endpts_done</span> <span class="ow">and</span> <span class="n">b_end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">endpts_done</span><span class="p">:</span>
                <span class="n">endpts_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_end</span><span class="p">)</span>
                <span class="n">endpts_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_end</span><span class="p">)</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Link added </span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="c1"># rename links&#39; interfaces</span>
    <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node_data</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">interfaces_rename</span> <span class="o">=</span> <span class="n">node_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;interfaces_rename&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">interfaces_rename</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> interfaces&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">interfaces_rename</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - interface rename need to have&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; &#39;find&#39; and &#39;replace&#39; defined, skipping: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;find&quot;</span><span class="p">]</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span>
            <span class="n">use_regex</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_regex&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># go over links one by one and rename interfaces</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;endpoints&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">node_name</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">use_regex</span><span class="p">:</span>
                        <span class="n">renamed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                            <span class="n">pattern</span><span class="p">,</span>
                            <span class="n">replace</span><span class="p">,</span>
                            <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">renamed</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">renamed</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> interface </span><span class="si">{</span><span class="n">endpoint</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> renamed to </span><span class="si">{</span><span class="n">renamed</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renamed</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.delete_branch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_branch</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.delete_branch" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Deletes a branch with the specified name from the NetBox instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The job context for the operation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the branch to delete.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The NetBox instance name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Result</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An object containing the outcome of the deletion operation,
including whether the branch was found and deleted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3841</span>
<span class="normal">3842</span>
<span class="normal">3843</span>
<span class="normal">3844</span>
<span class="normal">3845</span>
<span class="normal">3846</span>
<span class="normal">3847</span>
<span class="normal">3848</span>
<span class="normal">3849</span>
<span class="normal">3850</span>
<span class="normal">3851</span>
<span class="normal">3852</span>
<span class="normal">3853</span>
<span class="normal">3854</span>
<span class="normal">3855</span>
<span class="normal">3856</span>
<span class="normal">3857</span>
<span class="normal">3858</span>
<span class="normal">3859</span>
<span class="normal">3860</span>
<span class="normal">3861</span>
<span class="normal">3862</span>
<span class="normal">3863</span>
<span class="normal">3864</span>
<span class="normal">3865</span>
<span class="normal">3866</span>
<span class="normal">3867</span>
<span class="normal">3868</span>
<span class="normal">3869</span>
<span class="normal">3870</span>
<span class="normal">3871</span>
<span class="normal">3872</span>
<span class="normal">3873</span>
<span class="normal">3874</span>
<span class="normal">3875</span>
<span class="normal">3876</span>
<span class="normal">3877</span>
<span class="normal">3878</span>
<span class="normal">3879</span>
<span class="normal">3880</span>
<span class="normal">3881</span>
<span class="normal">3882</span>
<span class="normal">3883</span>
<span class="normal">3884</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span>
    <span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()}</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_branch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a branch with the specified name from the NetBox instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        job (Job): The job context for the operation.</span>
<span class="sd">        branch (str, optional): The name of the branch to delete.</span>
<span class="sd">        instance (str, optional): The NetBox instance name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Result: An object containing the outcome of the deletion operation,</span>
<span class="sd">            including whether the branch was found and deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:delete_branch&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting branch &#39;</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&#39;, Netbo instance &#39;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">nb_branch</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">branching</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nb_branch</span><span class="p">:</span>
        <span class="n">nb_branch</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&#39; deleted from &#39;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&#39; Netbox instance&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&#39; branch does not exist in &#39;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&#39; Netbox instance&quot;</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.expand_alphanumeric_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">expand_alphanumeric_range</span><span class="p">(</span><span class="n">range_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.expand_alphanumeric_range" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Expand alphanumeric ranges.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <ul>
<li>Ethernet[1-3] -&gt; ['Ethernet1', 'Ethernet2', 'Ethernet3']</li>
<li>[ge,xe]-0/0/[0-9] -&gt; ['ge-0/0/0', 'ge-0/0/1', ..., 'xe-0/0/9']</li>
</ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3886</span>
<span class="normal">3887</span>
<span class="normal">3888</span>
<span class="normal">3889</span>
<span class="normal">3890</span>
<span class="normal">3891</span>
<span class="normal">3892</span>
<span class="normal">3893</span>
<span class="normal">3894</span>
<span class="normal">3895</span>
<span class="normal">3896</span>
<span class="normal">3897</span>
<span class="normal">3898</span>
<span class="normal">3899</span>
<span class="normal">3900</span>
<span class="normal">3901</span>
<span class="normal">3902</span>
<span class="normal">3903</span>
<span class="normal">3904</span>
<span class="normal">3905</span>
<span class="normal">3906</span>
<span class="normal">3907</span>
<span class="normal">3908</span>
<span class="normal">3909</span>
<span class="normal">3910</span>
<span class="normal">3911</span>
<span class="normal">3912</span>
<span class="normal">3913</span>
<span class="normal">3914</span>
<span class="normal">3915</span>
<span class="normal">3916</span>
<span class="normal">3917</span>
<span class="normal">3918</span>
<span class="normal">3919</span>
<span class="normal">3920</span>
<span class="normal">3921</span>
<span class="normal">3922</span>
<span class="normal">3923</span>
<span class="normal">3924</span>
<span class="normal">3925</span>
<span class="normal">3926</span>
<span class="normal">3927</span>
<span class="normal">3928</span>
<span class="normal">3929</span>
<span class="normal">3930</span>
<span class="normal">3931</span>
<span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">expand_alphanumeric_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand alphanumeric ranges.</span>

<span class="sd">    Examples:</span>
<span class="sd">        - Ethernet[1-3] -&gt; [&#39;Ethernet1&#39;, &#39;Ethernet2&#39;, &#39;Ethernet3&#39;]</span>
<span class="sd">        - [ge,xe]-0/0/[0-9] -&gt; [&#39;ge-0/0/0&#39;, &#39;ge-0/0/1&#39;, ..., &#39;xe-0/0/9&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find all bracketed patterns</span>
    <span class="n">bracket_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[([^\]]+)\]&quot;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">bracket_pattern</span><span class="p">,</span> <span class="n">range_pattern</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
        <span class="c1"># No ranges found, return as-is</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">range_pattern</span><span class="p">]</span>

    <span class="c1"># Start with a single template</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">[</span><span class="n">range_pattern</span><span class="p">]</span>

    <span class="c1"># Process each bracket from left to right</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">bracket_content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_templates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check if it&#39;s a comma-separated list</span>
        <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">bracket_content</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">bracket_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="n">new_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">bracket_content</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Check if it&#39;s a numeric range</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">bracket_content</span>
            <span class="ow">and</span> <span class="n">bracket_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">bracket_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">new_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">bracket_content</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="mi">1</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># If conversion fails, treat as literal</span>
                    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                        <span class="n">new_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">bracket_content</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">bracket_content</span><span class="p">,</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat as literal</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
                <span class="n">new_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">bracket_content</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">bracket_content</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">templates</span> <span class="o">=</span> <span class="n">new_templates</span>

    <span class="k">return</span> <span class="n">templates</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.create_device_interfaces" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_device_interfaces</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">interface_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">interface_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.create_device_interfaces" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Create interfaces for one or more devices in NetBox. This task creates interfaces in bulk and only
if interfaces does not exist in Netbox.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The job object containing execution context and metadata.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of device names or device objects to create interfaces for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface_name</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="list">list</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name(s) of the interface(s) to create. Can be a single
interface name as a string or multiple names as a list. Alphanumeric ranges are
supported for bulk creation:</p>
<ul>
<li>Ethernet[1-3] -&gt; Ethernet1, Ethernet2, Ethernet3</li>
<li>[ge,xe]-0/0/[0-9] -&gt; ge-0/0/0, ..., xe-0/0/0 etc.</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interface_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of interface (e.g., "other", "virtual", "lag",
"1000base-t"). Defaults to "other".</p>
              </div>
            </td>
            <td>
                  <code>&#39;other&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox instance identifier to use. If None,
uses the default instance. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, simulates the operation without making actual changes.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>branch</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NetBox branch to use for the operation. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any additional interface attributes</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Result</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Result object containing the task name, execution results, and affected resources.
The result dictionary contains status and details of interface creation operations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span>
<span class="normal">3971</span>
<span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span>
<span class="normal">3991</span>
<span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span>
<span class="normal">4024</span>
<span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span>
<span class="normal">4075</span>
<span class="normal">4076</span>
<span class="normal">4077</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_device_interfaces</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">interface_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">interface_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create interfaces for one or more devices in NetBox. This task creates interfaces in bulk and only</span>
<span class="sd">    if interfaces does not exist in Netbox.</span>

<span class="sd">    Args:</span>
<span class="sd">        job (Job): The job object containing execution context and metadata.</span>
<span class="sd">        devices (list): List of device names or device objects to create interfaces for.</span>
<span class="sd">        interface_name (Union[list, str]): Name(s) of the interface(s) to create. Can be a single</span>
<span class="sd">            interface name as a string or multiple names as a list. Alphanumeric ranges are</span>
<span class="sd">            supported for bulk creation:</span>

<span class="sd">            - Ethernet[1-3] -&gt; Ethernet1, Ethernet2, Ethernet3</span>
<span class="sd">            - [ge,xe]-0/0/[0-9] -&gt; ge-0/0/0, ..., xe-0/0/0 etc.</span>

<span class="sd">        interface_type (str, optional): Type of interface (e.g., &quot;other&quot;, &quot;virtual&quot;, &quot;lag&quot;,</span>
<span class="sd">            &quot;1000base-t&quot;). Defaults to &quot;other&quot;.</span>
<span class="sd">        instance (Union[None, str], optional): NetBox instance identifier to use. If None,</span>
<span class="sd">            uses the default instance. Defaults to None.</span>
<span class="sd">        dry_run (bool, optional): If True, simulates the operation without making actual changes.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        branch (str, optional): NetBox branch to use for the operation. Defaults to None.</span>
<span class="sd">        kwargs (dict, optional): Any additional interface attributes</span>

<span class="sd">    Returns:</span>
<span class="sd">        Result: Result object containing the task name, execution results, and affected resources.</span>
<span class="sd">            The result dictionary contains status and details of interface creation operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:create_device_interfaces&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>

    <span class="c1"># Normalize interface_name to a list</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">interface_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">interface_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interface_names</span> <span class="o">=</span> <span class="n">interface_name</span>

    <span class="c1"># Expand all interface name patterns</span>
    <span class="n">all_interface_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name_pattern</span> <span class="ow">in</span> <span class="n">interface_names</span><span class="p">:</span>
        <span class="n">all_interface_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_alphanumeric_range</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">))</span>

    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Expanded interface names to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_interface_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> interface(s)&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Process each device</span>
    <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get device from NetBox</span>
            <span class="n">nb_device</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">device_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_device</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39; not found in NetBox&quot;</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get existing interfaces for this device</span>
            <span class="n">existing_interfaces</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device_name</span><span class="p">)</span>
            <span class="n">existing_interface_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">intf</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">existing_interfaces</span><span class="p">}</span>

            <span class="c1"># Prepare interfaces to create</span>
            <span class="n">interfaces_to_create</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">intf_name</span> <span class="ow">in</span> <span class="n">all_interface_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">intf_name</span> <span class="ow">in</span> <span class="n">existing_interface_names</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intf_name</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Build interface data</span>
                <span class="n">intf_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">nb_device</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">intf_name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">interface_type</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="n">interfaces_to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intf_data</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="s2">&quot;created&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intf_name</span><span class="p">)</span>

            <span class="c1"># Create interfaces in bulk if not dry_run</span>
            <span class="k">if</span> <span class="n">interfaces_to_create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nb</span><span class="o">.</span><span class="n">dcim</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">interfaces_to_create</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interfaces_to_create</span><span class="p">)</span><span class="si">}</span><span class="s2"> interface(s) on device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to create interfaces on device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">interfaces_to_create</span> <span class="ow">and</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[DRY RUN] Would create </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interfaces_to_create</span><span class="p">)</span><span class="si">}</span><span class="s2"> interface(s) on device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error processing device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="norfab.workers.netbox_worker.NetboxWorker.get_bgp_peerings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_bgp_peerings</span><span class="p">(</span><span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span></code>

<a href="#norfab.workers.netbox_worker.NetboxWorker.get_bgp_peerings" class="headerlink" title="Permanent link"></a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve device BGP peerings from Netbox using REST API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><span title="norfab.core.worker.Job">Job</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NorFab Job object containing relevant metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>instance</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Netbox instance name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>devices</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of devices to retrieve BGP peerings for.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cache usage options:</p>
<ul>
<li>True: Use data stored in cache if it is up to date, refresh it otherwise.</li>
<li>False: Do not use cache and do not update cache.</li>
<li>refresh: Ignore data in cache and replace it with data fetched from Netbox.</li>
<li>force: Use data in cache without checking if it is up to date.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="norfab.models.Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary keyed by device name with BGP peerings details.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span>
<span class="normal">4090</span>
<span class="normal">4091</span>
<span class="normal">4092</span>
<span class="normal">4093</span>
<span class="normal">4094</span>
<span class="normal">4095</span>
<span class="normal">4096</span>
<span class="normal">4097</span>
<span class="normal">4098</span>
<span class="normal">4099</span>
<span class="normal">4100</span>
<span class="normal">4101</span>
<span class="normal">4102</span>
<span class="normal">4103</span>
<span class="normal">4104</span>
<span class="normal">4105</span>
<span class="normal">4106</span>
<span class="normal">4107</span>
<span class="normal">4108</span>
<span class="normal">4109</span>
<span class="normal">4110</span>
<span class="normal">4111</span>
<span class="normal">4112</span>
<span class="normal">4113</span>
<span class="normal">4114</span>
<span class="normal">4115</span>
<span class="normal">4116</span>
<span class="normal">4117</span>
<span class="normal">4118</span>
<span class="normal">4119</span>
<span class="normal">4120</span>
<span class="normal">4121</span>
<span class="normal">4122</span>
<span class="normal">4123</span>
<span class="normal">4124</span>
<span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span>
<span class="normal">4141</span>
<span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span>
<span class="normal">4181</span>
<span class="normal">4182</span>
<span class="normal">4183</span>
<span class="normal">4184</span>
<span class="normal">4185</span>
<span class="normal">4186</span>
<span class="normal">4187</span>
<span class="normal">4188</span>
<span class="normal">4189</span>
<span class="normal">4190</span>
<span class="normal">4191</span>
<span class="normal">4192</span>
<span class="normal">4193</span>
<span class="normal">4194</span>
<span class="normal">4195</span>
<span class="normal">4196</span>
<span class="normal">4197</span>
<span class="normal">4198</span>
<span class="normal">4199</span>
<span class="normal">4200</span>
<span class="normal">4201</span>
<span class="normal">4202</span>
<span class="normal">4203</span>
<span class="normal">4204</span>
<span class="normal">4205</span>
<span class="normal">4206</span>
<span class="normal">4207</span>
<span class="normal">4208</span>
<span class="normal">4209</span>
<span class="normal">4210</span>
<span class="normal">4211</span>
<span class="normal">4212</span>
<span class="normal">4213</span>
<span class="normal">4214</span>
<span class="normal">4215</span>
<span class="normal">4216</span>
<span class="normal">4217</span>
<span class="normal">4218</span>
<span class="normal">4219</span>
<span class="normal">4220</span>
<span class="normal">4221</span>
<span class="normal">4222</span>
<span class="normal">4223</span>
<span class="normal">4224</span>
<span class="normal">4225</span>
<span class="normal">4226</span>
<span class="normal">4227</span>
<span class="normal">4228</span>
<span class="normal">4229</span>
<span class="normal">4230</span>
<span class="normal">4231</span>
<span class="normal">4232</span>
<span class="normal">4233</span>
<span class="normal">4234</span>
<span class="normal">4235</span>
<span class="normal">4236</span>
<span class="normal">4237</span>
<span class="normal">4238</span>
<span class="normal">4239</span>
<span class="normal">4240</span>
<span class="normal">4241</span>
<span class="normal">4242</span>
<span class="normal">4243</span>
<span class="normal">4244</span>
<span class="normal">4245</span>
<span class="normal">4246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Task</span><span class="p">(</span><span class="n">fastapi</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span> <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">NetboxFastApiArgs</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_bgp_peerings</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve device BGP peerings from Netbox using REST API.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: NorFab Job object containing relevant metadata</span>
<span class="sd">        instance (str, optional): Netbox instance name.</span>
<span class="sd">        devices (list, optional): List of devices to retrieve BGP peerings for.</span>
<span class="sd">        cache (Union[bool, str], optional): Cache usage options:</span>

<span class="sd">            - True: Use data stored in cache if it is up to date, refresh it otherwise.</span>
<span class="sd">            - False: Do not use cache and do not update cache.</span>
<span class="sd">            - refresh: Ignore data in cache and replace it with data fetched from Netbox.</span>
<span class="sd">            - force: Use data in cache without checking if it is up to date.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary keyed by device name with BGP peerings details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_instance</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_use</span> <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:get_bgp_peerings&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">},</span>
        <span class="n">resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Check if BGP plugin is installed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_plugin</span><span class="p">(</span><span class="s2">&quot;netbox_bgp&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> Netbox instance has no BGP Plugin installed&quot;</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>

    <span class="c1"># Get device details to collect device IDs</span>
    <span class="n">devices_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_devices</span><span class="p">(</span>
        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">devices_result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to retrieve device details: </span><span class="si">{</span><span class="n">devices_result</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="n">nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pynetbox</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="c1"># Skip devices not found in Netbox</span>
        <span class="k">if</span> <span class="n">device_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">devices_result</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Device &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39; not found in Netbox&quot;</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">device_id</span> <span class="o">=</span> <span class="n">devices_result</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;get_bgp_peerings::</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

        <span class="c1"># Mode: force with cached data - use cache directly</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;force&quot;</span> <span class="ow">and</span> <span class="n">cached_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_data</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using cached BGP peerings for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39; (forced)&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Mode: cache disabled - fetch without caching</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">bgp_sessions</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">bgp</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bgp_sessions</span><span class="p">}</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">])</span><span class="si">}</span><span class="s2"> BGP session(s) for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Mode: refresh or no cached data - fetch and cache</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span> <span class="ow">or</span> <span class="n">cached_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;refresh&quot;</span> <span class="ow">and</span> <span class="n">cached_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bgp_sessions</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">bgp</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bgp_sessions</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">cache_key</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">],</span> <span class="n">expire</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>
            <span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fetched and cached </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">])</span><span class="si">}</span><span class="s2"> BGP session(s) for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Mode: cache=True with cached data - smart update (only fetch changed sessions)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> BGP session(s) from cache for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Fetch brief session info to compare timestamps</span>
        <span class="n">brief_sessions</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">bgp</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;id,last_updated,name&quot;</span>
        <span class="p">)</span>
        <span class="n">netbox_sessions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">last_updated</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">brief_sessions</span>
        <span class="p">}</span>

        <span class="c1"># Build lookup maps</span>
        <span class="n">cached_by_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cached_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">session_ids_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sessions_to_remove</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Find stale sessions (exist in both but timestamps differ) and deleted sessions</span>
        <span class="k">for</span> <span class="n">session_name</span><span class="p">,</span> <span class="n">cached_session</span> <span class="ow">in</span> <span class="n">cached_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cached_id</span> <span class="o">=</span> <span class="n">cached_session</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cached_id</span> <span class="ow">in</span> <span class="n">netbox_sessions</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">cached_session</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                    <span class="o">!=</span> <span class="n">netbox_sessions</span><span class="p">[</span><span class="n">cached_id</span><span class="p">][</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">session_ids_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cached_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sessions_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>

        <span class="c1"># Find new sessions in Netbox not in cache</span>
        <span class="k">for</span> <span class="n">nb_id</span> <span class="ow">in</span> <span class="n">netbox_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cached_by_id</span><span class="p">:</span>
                <span class="n">session_ids_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb_id</span><span class="p">)</span>

        <span class="c1"># Remove deleted sessions</span>
        <span class="k">for</span> <span class="n">session_name</span> <span class="ow">in</span> <span class="n">sessions_to_remove</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">session_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Removed deleted session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; from cache for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Fetch updated/new sessions</span>
        <span class="k">if</span> <span class="n">session_ids_to_fetch</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fetching </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">session_ids_to_fetch</span><span class="p">)</span><span class="si">}</span><span class="s2"> updated BGP session(s) for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">bgp</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">session_ids_to_fetch</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">][</span><span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="c1"># Update cache if any changes occurred</span>
        <span class="k">if</span> <span class="n">session_ids_to_fetch</span> <span class="ow">or</span> <span class="n">sessions_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">cache_key</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">device_name</span><span class="p">],</span> <span class="n">expire</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>
            <span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated cache for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using cache, it is up to date for &#39;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="norfab.workers.netbox_worker.compare_netbox_object_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_netbox_object_state</span><span class="p">(</span><span class="n">desired_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ignore_fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore_if_not_empty</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span></code>

<a href="#norfab.workers.netbox_worker.compare_netbox_object_state" class="headerlink" title="Permanent link"></a></h2>


    <div class="doc doc-contents ">

        <p>Compare desired state with current NetBox object state and return fields that need updating.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>desired_state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with desired field values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with current NetBox object field values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_fields</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of field names to ignore completely.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_if_not_empty</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of field names to ignore if they have
non-empty values in current_state (won't overwrite existing data).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>diff</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to accumulate field differences. If not provided,
a new dictionary will be created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- updates (dict): Dictionary containing only fields that need to be updated with their new values.
- diff (dict): Dictionary containing the differences with '+' (new value) and '-' (old value) keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p _ABC123_="&quot;ABC123&quot;" _serial_:="&quot;serial&quot;:">desired = {"serial": "ABC123", "asset_tag": "TAG001", "comments": "New comment"}
current = {"serial": "OLD123", "asset_tag": "TAG001", "comments": "Existing"}
ignore_fields = ["comments"]
ignore_if_not_empty = []
updates, diff = compare_netbox_object_state(desired, current, ignore_fields, ignore_if_not_empty)
updates</p>
<p _ABC123_="&quot;ABC123&quot;," _TAG001_="&quot;TAG001&quot;" _asset_tag_:="&quot;asset_tag&quot;:" _serial_:="&quot;serial&quot;:">desired = {"serial": "ABC123", "asset_tag": "TAG001", "comments": "New comment"}
current = {"serial": "OLD123", "asset_tag": "", "comments": "Existing"}
ignore_fields = []
ignore_if_not_empty = ["comments"]
updates, diff = compare_netbox_object_state(desired, current, ignore_fields, ignore_if_not_empty)
updates</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>norfab\workers\netbox_worker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_netbox_object_state</span><span class="p">(</span>
    <span class="n">desired_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">current_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">ignore_fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_if_not_empty</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">diff</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare desired state with current NetBox object state and return fields that need updating.</span>

<span class="sd">    Args:</span>
<span class="sd">        desired_state (dict): Dictionary with desired field values.</span>
<span class="sd">        current_state (dict): Dictionary with current NetBox object field values.</span>
<span class="sd">        ignore_fields (list, optional): List of field names to ignore completely.</span>
<span class="sd">        ignore_if_not_empty (list, optional): List of field names to ignore if they have</span>
<span class="sd">            non-empty values in current_state (won&#39;t overwrite existing data).</span>
<span class="sd">        diff (dict, optional): Dictionary to accumulate field differences. If not provided,</span>
<span class="sd">            a new dictionary will be created.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - updates (dict): Dictionary containing only fields that need to be updated with their new values.</span>
<span class="sd">            - diff (dict): Dictionary containing the differences with &#39;+&#39; (new value) and &#39;-&#39; (old value) keys.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; desired = {&quot;serial&quot;: &quot;ABC123&quot;, &quot;asset_tag&quot;: &quot;TAG001&quot;, &quot;comments&quot;: &quot;New comment&quot;}</span>
<span class="sd">        &gt;&gt;&gt; current = {&quot;serial&quot;: &quot;OLD123&quot;, &quot;asset_tag&quot;: &quot;TAG001&quot;, &quot;comments&quot;: &quot;Existing&quot;}</span>
<span class="sd">        &gt;&gt;&gt; ignore_fields = [&quot;comments&quot;]</span>
<span class="sd">        &gt;&gt;&gt; ignore_if_not_empty = []</span>
<span class="sd">        &gt;&gt;&gt; updates, diff = compare_netbox_object_state(desired, current, ignore_fields, ignore_if_not_empty)</span>
<span class="sd">        &gt;&gt;&gt; updates</span>
<span class="sd">        {&quot;serial&quot;: &quot;ABC123&quot;}</span>

<span class="sd">        &gt;&gt;&gt; desired = {&quot;serial&quot;: &quot;ABC123&quot;, &quot;asset_tag&quot;: &quot;TAG001&quot;, &quot;comments&quot;: &quot;New comment&quot;}</span>
<span class="sd">        &gt;&gt;&gt; current = {&quot;serial&quot;: &quot;OLD123&quot;, &quot;asset_tag&quot;: &quot;&quot;, &quot;comments&quot;: &quot;Existing&quot;}</span>
<span class="sd">        &gt;&gt;&gt; ignore_fields = []</span>
<span class="sd">        &gt;&gt;&gt; ignore_if_not_empty = [&quot;comments&quot;]</span>
<span class="sd">        &gt;&gt;&gt; updates, diff = compare_netbox_object_state(desired, current, ignore_fields, ignore_if_not_empty)</span>
<span class="sd">        &gt;&gt;&gt; updates</span>
<span class="sd">        {&quot;serial&quot;: &quot;ABC123&quot;, &quot;asset_tag&quot;: &quot;TAG001&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ignore_fields</span> <span class="o">=</span> <span class="n">ignore_fields</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">ignore_if_not_empty</span> <span class="o">=</span> <span class="n">ignore_if_not_empty</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">desired_value</span> <span class="ow">in</span> <span class="n">desired_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Skip if field is in ignore list</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ignore_fields</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Get current value, default to None if field doesn&#39;t exist</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># Skip if field is in ignore_if_not_empty and current value is not empty</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ignore_if_not_empty</span> <span class="ow">and</span> <span class="n">current_value</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Compare values and add to updates if different</span>
        <span class="k">if</span> <span class="n">current_value</span> <span class="o">!=</span> <span class="n">desired_value</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">desired_value</span>
            <span class="n">diff</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
                <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">desired_value</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">updates</span><span class="p">,</span> <span class="n">diff</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/dmulyalin" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/DMulyalin" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "toc.follow", "navigation.instant", "navigation.instant.progress", "content.footnote.tooltips", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>